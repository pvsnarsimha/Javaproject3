<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Query by State and Event Category</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            transition: background-color 0.3s, color 0.3s;
        }
        .dark-mode {
            background-color: #1a1a1a;
            color: #ffffff;
        }
        .dark-mode .card, .dark-mode .table {
            background-color: #2c2c2c;
            border-color: #444;
        }
        .dark-mode .form-control, .dark-mode .form-select {
            background-color: #333;
            color: #fff;
            border-color: #555;
        }
        .card:hover {
            transform: translateY(-5px);
            transition: transform 0.2s;
        }
        .table-hover tbody tr:hover {
            background-color: rgba(0, 0, 0, 0.075);
            cursor: pointer;
        }
        .dark-mode .table-hover tbody tr:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .btn-loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border: 2px solid #fff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
        }
        @keyframes spin {
            to { transform: translateY(-50%) rotate(360deg); }
        }
        .radio-group .form-check-input:checked {
            background-color: #007bff;
            border-color: #007bff;
        }
        .form-invalid .form-control, .form-invalid .form-select {
            border-color: #dc3545;
        }
        .error-message {
            color: #dc3545;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        .table-container {
            max-height: 400px;
            overflow-y: auto;
            position: relative;
        }
        .table thead {
            position: sticky;
            top: 0;
            background: #fff;
            z-index: 10;
        }
        .dark-mode .table thead {
            background: #2c2c2c;
        }
        .sortable {
            cursor: pointer;
            user-select: none;
        }
        .sortable::after {
            content: '↕';
            margin-left: 5px;
            font-size: 0.8em;
        }
        .sort-asc::after { content: '↑'; }
        .sort-desc::after { content: '↓'; }
        .details-row {
            background-color: #f8f9fa;
        }
        .dark-mode .details-row {
            background-color: #333;
        }
        .autocomplete-suggestions {
            position: absolute;
            background: #fff;
            border: 1px solid #ccc;
            max-height: 150px;
            overflow-y: auto;
            z-index: 1000;
            width: calc(100% - 30px);
        }
        .dark-mode .autocomplete-suggestions {
            background: #333;
            border-color: #555;
            color: #fff;
        }
        .autocomplete-suggestions div {
            padding: 8px;
            cursor: pointer;
        }
        .autocomplete-suggestions div:hover {
            background: #e9ecef;
        }
        .dark-mode .autocomplete-suggestions div:hover {
            background: #444;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <a href="/" class="btn btn-outline-primary"><i class="bi bi-house"></i> Back to Home</a>
            <button id="themeToggle" class="btn btn-outline-secondary"><i class="bi bi-moon"></i> Toggle Theme</button>
        </div>

        <h2 class="mb-4"><i class="bi bi-search"></i> Query by State and Event Category</h2>

        <div class="card shadow-sm mb-4">
            <div class="card-header" data-bs-toggle="collapse" data-bs-target="#advancedFilters" aria-expanded="true" style="cursor: pointer;">
                <h5 class="mb-0"><i class="bi bi-filter"></i> Advanced Filters</h5>
            </div>
            <div id="advancedFilters" class="collapse show">
                <div class="card-body">
                    <form id="queryForm">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label for="searchInput" class="form-label">Search</label>
                                <input type="text" id="searchInput" name="search" class="form-control" placeholder="Search by state, category, or description">
                                <div id="searchSuggestions" class="autocomplete-suggestions d-none"></div>
                            </div>
                            <div class="col-md-3">
                                <label for="stateSelect" class="form-label">Select State</label>
                                <select id="stateSelect" name="state" class="form-select">
                                    <option value="">Select State</option>
                                    <option value="Andhra Pradesh">Andhra Pradesh</option>
                                    <option value="Telangana">Telangana</option>
                                    <option value="Karnataka">Karnataka</option>
                                </select>
                                <div id="stateError" class="error-message d-none">Please select a state.</div>
                            </div>
                            <div class="col-md-3">
                                <label for="categorySelect" class="form-label">Select Event Category</label>
                                <select id="categorySelect" name="eventCategory" class="form-select">
                                    <option value="">Select Event Category</option>
                                    <option value="Integrity Pledge">Integrity Pledge</option>
                                    <option value="Vendors Meet">Vendors Meet</option>
                                    <option value="Elocution">Elocution</option>
                                    <option value="Debate">Debate</option>
                                    <option value="Drawing">Drawing</option>
                                    <option value="Quiz">Quiz</option>
                                    <option value="Slogan">Slogan</option>
                                </select>
                                <div id="categoryError" class="error-message d-none">Please select an event category.</div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Select Operator</label>
                                <div class="radio-group">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="operator" id="operatorAND" value="AND" checked>
                                        <label class="form-check-label" for="operatorAND">AND</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="operator" id="operatorOR" value="OR">
                                        <label class="form-check-label" for="operatorOR">OR</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="operator" id="operatorNOT" value="NOT">
                                        <label class="form-check-label" for="operatorNOT">NOT</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row g-3 mt-3">
                            <div class="col-md-3">
                                <label for="recentQueries" class="form-label">Recent Queries</label>
                                <select id="recentQueries" class="form-select">
                                    <option value="">Select a recent query</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="saveQueryName" class="form-label">Save Query</label>
                                <input type="text" id="saveQueryName" class="form-control" placeholder="Enter query name">
                            </div>
                            <div class="col-md-6 d-flex align-items-end">
                                <button type="button" id="saveQueryBtn" class="btn btn-outline-success me-2"><i class="bi bi-save"></i> Save Query</button>
                                <button type="button" id="resetFiltersBtn" class="btn btn-outline-secondary me-2"><i class="bi bi-arrow-counterclockwise"></i> Reset Filters</button>
                                <button type="submit" id="runQueryBtn" class="btn btn-primary"><i class="bi bi-play"></i> Run Query</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="mb-3">
            <button class="btn btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#columnToggler"><i class="bi bi-table"></i> Toggle Columns</button>
            <div id="columnToggler" class="collapse mt-2">
                <div class="card card-body">
                    <div class="form-check form-check-inline" v-for="col in columns">
                        <input class="form-check-input" type="checkbox" :id="'col-' + col.key" v-model="col.visible">
                        <label class="form-check-label" :for="'col-' + col.key">{{ col.label }}</label>
                    </div>
                </div>
            </div>
        </div>

        <div id="loadingIndicator" class="text-center d-none">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>

        <div id="errorMessage" class="alert alert-danger d-none" role="alert"></div>

        <div id="summaryStats" class="card mb-3 d-none">
            <div class="card-body">
                <h5>Summary Statistics</h5>
                <p>Total Activities: <span id="totalActivities">0</span></p>
                <p>Unique States: <span id="uniqueStates">0</span></p>
                <p>Total Participants: <span id="totalParticipants">0</span></p>
            </div>
        </div>

        <div class="table-container">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th class="sortable" data-column="id">ID</th>
                        <th class="sortable" data-column="state">State</th>
                        <th class="sortable" data-column="stationName">Station Name</th>
                        <th class="sortable" data-column="activityType">Activity Type</th>
                        <th class="sortable" data-column="eventCategory">Event Category</th>
                        <th class="sortable" data-column="participantCategory">Participant Category</th>
                        <th class="sortable" data-column="eventDescription">Event Description</th>
                        <th class="sortable" data-column="schoolOrCollegeOrPanchayatName">School/College/Panchayat Name</th>
                        <th class="sortable" data-column="eventLocation">Event Location</th>
                        <th class="sortable" data-column="eventDate">Event Date</th>
                        <th class="sortable" data-column="numberOfParticipants">Number of Participants</th>
                        <th class="sortable" data-column="remarks">Remarks</th>
                    </tr>
                </thead>
                <tbody id="activityTableBody">
                    <tr>
                        <td colspan="12" class="text-center">No activities found</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <nav aria-label="Page navigation" class="mt-3">
            <ul class="pagination justify-content-center">
                <li class="page-item"><a class="page-link" href="#" id="prevPage">Previous</a></li>
                <li class="page-item"><a class="page-link" href="#" id="nextPage">Next</a></li>
            </ul>
        </nav>
    </div>

    <div class="modal fade" id="notOperatorModal" tabindex="-1" aria-labelledby="notOperatorModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="notOperatorModalLabel">Confirm NOT Operator</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    The NOT operator will exclude activities matching the selected state and/or event category. This may return a large number of results. Do you want to proceed?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmNotOperator">Proceed</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.0/dist/vue.global.prod.js"></script>
    <script>
        const { createApp } = Vue;
        const app = createApp({
            data() {
                return {
                    columns: [
                        { key: 'id', label: 'ID', visible: true },
                        { key: 'state', label: 'State', visible: true },
                        { key: 'stationName', label: 'Station Name', visible: true },
                        { key: 'activityType', label: 'Activity Type', visible: true },
                        { key: 'eventCategory', label: 'Event Category', visible: true },
                        { key: 'participantCategory', label: 'Participant Category', visible: true },
                        { key: 'eventDescription', label: 'Event Description', visible: true },
                        { key: 'schoolOrCollegeOrPanchayatName', label: 'School/College/Panchayat Name', visible: true },
                        { key: 'eventLocation', label: 'Event Location', visible: true },
                        { key: 'eventDate', label: 'Event Date', visible: true },
                        { key: 'numberOfParticipants', label: 'Number of Participants', visible: true },
                        { key: 'remarks', label: 'Remarks', visible: true }
                    ]
                };
            },
            watch: {
                columns: {
                    handler() {
                        this.updateTableVisibility();
                        localStorage.setItem('columnVisibility', JSON.stringify(this.columns));
                    },
                    deep: true
                }
            },
            methods: {
                updateTableVisibility() {
                    this.columns.forEach(col => {
                        $(`th[data-column="${col.key}"], td:nth-child(${this.columns.indexOf(col) + 1})`)
                            .toggle(col.visible);
                    });
                }
            },
            mounted() {
                const savedVisibility = localStorage.getItem('columnVisibility');
                if (savedVisibility) {
                    this.columns = JSON.parse(savedVisibility);
                    this.updateTableVisibility();
                }
            }
        }).mount('#columnToggler');

        $(document).ready(function() {
            let currentPage = 0;
            const pageSize = 10;
            let sortBy = 'id';
            let sortDir = 'asc';
            let expandedRows = new Set();
            let pendingNotQuery = false;

            // Theme toggle
            const toggleTheme = () => {
                $('body').toggleClass('dark-mode');
                const isDark = $('body').hasClass('dark-mode');
                $('#themeToggle').html(`<i class="bi bi-${isDark ? 'sun' : 'moon'}"></i> Toggle Theme`);
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            };

            if (localStorage.getItem('theme') === 'dark') {
                $('body').addClass('dark-mode');
                $('#themeToggle').html('<i class="bi bi-sun"></i> Toggle Theme');
            }
            $('#themeToggle').click(toggleTheme);

            // Persistent form state
            const loadFormState = () => {
                const savedState = localStorage.getItem('state');
                const savedCategory = localStorage.getItem('eventCategory');
                const savedOperator = localStorage.getItem('operator');
                const savedSearch = localStorage.getItem('search');
                if (savedState) $('#stateSelect').val(savedState);
                if (savedCategory) $('#categorySelect').val(savedCategory);
                if (savedOperator) $(`input[name="operator"][value="${savedOperator}"]`).prop('checked', true);
                if (savedSearch) $('#searchInput').val(savedSearch);
            };
            loadFormState();

            // Recent queries
            const loadRecentQueries = () => {
                const queries = JSON.parse(localStorage.getItem('recentQueries') || '[]');
                $('#recentQueries').empty().append('<option value="">Select a recent query</option>');
                queries.forEach(q => {
                    $('#recentQueries').append(`<option value="${q.name}">${q.name}</option>`);
                });
            };
            loadRecentQueries();

            $('#recentQueries').change(function() {
                const name = $(this).val();
                if (name) {
                    const queries = JSON.parse(localStorage.getItem('recentQueries') || '[]');
                    const query = queries.find(q => q.name === name);
                    if (query) {
                        $('#stateSelect').val(query.state);
                        $('#categorySelect').val(query.eventCategory);
                        $(`input[name="operator"][value="${query.operator}"]`).prop('checked', true);
                        $('#searchInput').val(query.search);
                        currentPage = 0;
                        fetchActivities();
                    }
                }
            });

            $('#saveQueryBtn').click(function() {
                const name = $('#saveQueryName').val().trim();
                if (!name) {
                    $('#errorMessage').text('Please enter a query name.').removeClass('d-none');
                    return;
                }
                const query = {
                    name,
                    state: $('#stateSelect').val(),
                    eventCategory: $('#categorySelect').val(),
                    operator: $('input[name="operator"]:checked').val(),
                    search: $('#searchInput').val()
                };
                const queries = JSON.parse(localStorage.getItem('recentQueries') || '[]');
                if (!queries.find(q => q.name === name)) {
                    queries.push(query);
                    localStorage.setItem('recentQueries', JSON.stringify(queries));
                    loadRecentQueries();
                    $('#saveQueryName').val('');
                    $('#errorMessage').text('Query saved successfully.').removeClass('d-none').removeClass('alert-danger').addClass('alert-success');
                    setTimeout(() => $('#errorMessage').addClass('d-none').removeClass('alert-success'), 2000);
                } else {
                    $('#errorMessage').text('Query name already exists.').removeClass('d-none');
                }
            });

            $('#resetFiltersBtn').click(function() {
                $('#queryForm')[0].reset();
                $('#stateSelect').val('');
                $('#categorySelect').val('');
                $('#searchInput').val('');
                $('input[name="operator"][value="AND"]').prop('checked', true);
                localStorage.removeItem('state');
                localStorage.removeItem('eventCategory');
                localStorage.removeItem('operator');
                localStorage.removeItem('search');
                currentPage = 0;
                fetchActivities();
            });

            // Form validation
            const validateForm = () => {
                let isValid = true;
                const state = $('#stateSelect').val();
                const category = $('#categorySelect').val();
                const operator = $('input[name="operator"]:checked').val();

                $('#stateSelect').removeClass('form-invalid');
                $('#categorySelect').removeClass('form-invalid');
                $('#stateError').addClass('d-none');
                $('#categoryError').addClass('d-none');

                if (operator === 'NOT') {
                    if (!state && !category) {
                        $('#stateSelect').addClass('form-invalid');
                        $('#categorySelect').addClass('form-invalid');
                        $('#stateError').text('Please select at least one of state or event category for NOT operator.').removeClass('d-none');
                        $('#categoryError').text('Please select at least one of state or event category for NOT operator.').removeClass('d-none');
                        isValid = false;
                    }
                } else {
                    if (!state) {
                        $('#stateSelect').addClass('form-invalid');
                        $('#stateError').removeClass('d-none');
                        isValid = false;
                    }
                    if (!category) {
                        $('#categorySelect').addClass('form-invalid');
                        $('#categoryError').removeClass('d-none');
                        isValid = false;
                    }
                }
                return isValid;
            };

            // Auto-suggest for search
            const suggestions = [
                'Andhra Pradesh', 'Telangana', 'Karnataka',
                'Integrity Pledge', 'Vendors Meet', 'Elocution', 'Debate', 'Drawing', 'Quiz', 'Slogan'
            ];
            $('#searchInput').on('input', function() {
                const value = $(this).val().toLowerCase();
                $('#searchSuggestions').empty().addClass('d-none');
                if (value) {
                    const matches = suggestions.filter(s => s.toLowerCase().includes(value));
                    if (matches.length) {
                        matches.forEach(m => {
                            $('#searchSuggestions').append(`<div>${m}</div>`);
                        });
                        $('#searchSuggestions').removeClass('d-none');
                    }
                }
            });
            $('#searchSuggestions').on('click', 'div', function() {
                $('#searchInput').val($(this).text());
                $('#searchSuggestions').addClass('d-none');
                fetchActivities();
            });

            // Sorting
            $('.sortable').click(function() {
                const column = $(this).data('column');
                if (sortBy === column) {
                    sortDir = sortDir === 'asc' ? 'desc' : 'asc';
                } else {
                    sortBy = column;
                    sortDir = 'asc';
                }
                $('.sortable').removeClass('sort-asc sort-desc');
                $(this).addClass(`sort-${sortDir}`);
                currentPage = 0;
                fetchActivities();
            });

            // Expandable rows
            $('#activityTableBody').on('click', 'tr:not(.details-row)', function() {
                const id = $(this).data('id');
                if (expandedRows.has(id)) {
                    $(`#details-${id}`).remove();
                    expandedRows.delete(id);
                } else {
                    const activity = $(this).data('activity');
                    const detailsRow = `
                        <tr id="details-${id}" class="details-row">
                            <td colspan="12">
                                <div class="p-3">
                                    <strong>Full Description:</strong> ${activity.eventDescription || 'N/A'}<br>
                                    <strong>Remarks:</strong> ${activity.remarks || 'N/A'}
                                </div>
                            </td>
                        </tr>`;
                    $(this).after(detailsRow);
                    expandedRows.add(id);
                }
            });

            // Virtual scrolling
            $('.table-container').scroll(function() {
                const container = $(this);
                if (container.scrollTop() + container.innerHeight() >= container[0].scrollHeight - 50) {
                    currentPage++;
                    fetchActivities(true);
                }
            });

            // Fetch activities
            const fetchActivities = (append = false) => {
                if (!validateForm()) {
                    if ($('input[name="operator"]:checked').val() === 'NOT') {
                        pendingNotQuery = true;
                        $('#notOperatorModal').modal('show');
                    }
                    return;
                }

                $('#runQueryBtn').addClass('btn-loading').prop('disabled', true);
                $('#loadingIndicator').removeClass('d-none');
                $('#errorMessage').addClass('d-none');

                const formData = {
                    state: $('#stateSelect').val() || '',
                    eventCategory: $('#categorySelect').val() || '',
                    operator: $('input[name="operator"]:checked').val(),
                    search: $('#searchInput').val(),
                    page: currentPage,
                    size: pageSize,
                    sortBy,
                    sortDir
                };

                localStorage.setItem('state', formData.state);
                localStorage.setItem('eventCategory', formData.eventCategory);
                localStorage.setItem('operator', formData.operator);
                localStorage.setItem('search', formData.search);

                $.ajax({
                    url: '/api/stateCategoryQuery',
                    method: 'POST',
                    data: formData,
                    success: function(response) {
                        if (!append) $('#activityTableBody').empty();
                        if (response.errorMessage) {
                            $('#errorMessage').text(response.errorMessage).removeClass('d-none');
                            $('#activityTableBody').append('<tr><td colspan="12" class="text-center">No activities found</td></tr>');
                        } else if (response.activities.length === 0) {
                            if (!append) $('#activityTableBody').append('<tr><td colspan="12" class="text-center">No activities found</td></tr>');
                        } else {
                            response.activities.forEach(activity => {
                                const row = `
                                    <tr data-id="${activity.id}" data-activity='${JSON.stringify(activity)}'>
                                        <td>${activity.id}</td>
                                        <td>${activity.state || ''}</td>
                                        <td>${activity.stationName || ''}</td>
                                        <td>${activity.activityType || ''}</td>
                                        <td>${activity.eventCategory || ''}</td>
                                        <td>${activity.participantCategory || ''}</td>
                                        <td>${(activity.eventDescription || '').substring(0, 50)}${activity.eventDescription && activity.eventDescription.length > 50 ? '...' : ''}</td>
                                        <td>${activity.schoolOrCollegeOrPanchayatName || ''}</td>
                                        <td>${activity.eventLocation || ''}</td>
                                        <td>${activity.eventDate || ''}</td>
                                        <td>${activity.numberOfParticipants || 0}</td>
                                        <td>${(activity.remarks || '').substring(0, 50)}${activity.remarks && activity.remarks.length > 50 ? '...' : ''}</td>
                                    </tr>`;
                                $('#activityTableBody').append(row);
                            });
                            updateSummaryStats(response.totalElements, response.uniqueStates, response.totalParticipants);
                        }
                        $('#prevPage').parent().toggleClass('disabled', currentPage === 0);
                        $('#nextPage').parent().toggleClass('disabled', response.activities.length < pageSize);
                    },
                    error: function() {
                        $('#errorMessage').text('An error occurred while fetching activities.').removeClass('d-none');
                        if (!append) $('#activityTableBody').append('<tr><td colspan="12" class="text-center">No activities found</td></tr>');
                    },
                    complete: function() {
                        $('#runQueryBtn').removeClass('btn-loading').prop('disabled', false);
                        $('#loadingIndicator').addClass('d-none');
                    }
                });
            };

            const updateSummaryStats = (total, uniqueStates, totalParticipants) => {
                $('#totalActivities').text(total);
                $('#uniqueStates').text(uniqueStates);
                $('#totalParticipants').text(totalParticipants);
                $('#summaryStats').removeClass('d-none');
            };

            $('#queryForm').submit(function(e) {
                e.preventDefault();
                currentPage = 0;
                pendingNotQuery = $('input[name="operator"]:checked').val() === 'NOT';
                if (pendingNotQuery) {
                    $('#notOperatorModal').modal('show');
                } else {
                    fetchActivities();
                }
            });

            $('#confirmNotOperator').click(function() {
                $('#notOperatorModal').modal('hide');
                if (pendingNotQuery) {
                    currentPage = 0;
                    fetchActivities();
                    pendingNotQuery = false;
                }
            });

            $('#notOperatorModal').on('hidden.bs.modal', function() {
                if (!pendingNotQuery) {
                    $('#runQueryBtn').focus();
                }
            });

            $('#prevPage').click(function(e) {
                e.preventDefault();
                if (currentPage > 0) {
                    currentPage--;
                    fetchActivities();
                }
            });

            $('#nextPage').click(function(e) {
                e.preventDefault();
                currentPage++;
                fetchActivities();
            });

            // Keyboard shortcuts
            $(document).keydown(function(e) {
                if (e.ctrlKey && e.key === 'Enter') {
                    $('#queryForm').submit();
                } else if (e.ctrlKey && e.key === 'r') {
                    e.preventDefault();
                    $('#resetFiltersBtn').click();
                } else if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    $('#saveQueryBtn').click();
                }
            });

            // Focus management
            $('#queryForm').find('input, select').on('keydown', function(e) {
                if (e.key === 'Tab') {
                    e.preventDefault();
                    const inputs = $('#queryForm').find('input:visible, select:visible');
                    const currentIndex = inputs.index(this);
                    const nextIndex = (currentIndex + 1) % inputs.length;
                    inputs.eq(nextIndex).focus();
                }
            });

            $('#stateSelect, #categorySelect, #searchInput').focus(function() {
                $(this).select();
            });

            // SSE for real-time updates
            const eventSource = new EventSource('/activities/updates');
            eventSource.onmessage = function(event) {
                const update = JSON.parse(event.data);
                if (update.action === 'HEARTBEAT') return;
                if ($('#stateSelect').val() && $('#categorySelect').val()) {
                    currentPage = 0;
                    fetchActivities();
                }
            };
            eventSource.onerror = function() {
                console.error('SSE connection error');
                eventSource.close();
            };

            // Initial fetch
            if ($('#stateSelect').val() && $('#categorySelect').val()) {
                fetchActivities();
            }
        });
    </script>
</body>
</html>