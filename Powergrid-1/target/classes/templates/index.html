<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Manage and track activities with real-time updates">
    <title>Activities List</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.9/dist/flatpickr.min.css" rel="stylesheet">
    <link href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.9/dist/flatpickr.min.js"></script>
    <style>
        :root {
            --bg-color: #fff;
            --text-color: #333;
            --table-bg: #fff;
            --table-border: #dee2e6;
            --btn-primary-bg: #5A2D84;
        }
        [data-theme="dark"] {
            --bg-color: #222;
            --text-color: #ddd;
            --table-bg: #333;
            --table-border: #555;
            --btn-primary-bg: #7a4aa3;
        }
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: all 0.3s;
        }
        .table {
            background-color: var(--table-bg);
            border-color: var(--table-border);
        }
        .table th, .table td {
            vertical-align: middle;
        }
        .table th {
            cursor: pointer;
            position: relative;
        }
        .table th.sort-asc::after {
            content: ' ↑';
        }
        .table th.sort-desc::after {
            content: ' ↓';
        }
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }
        .editable:hover {
            background-color: #f8f9fa;
        }
        .navbar {
            position: sticky;
            top: 0;
            z-index: 1000;
            background-color: var(--bg-color);
            padding: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .spinner {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--btn-primary-bg);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        .session-warning {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
        }
        @media (max-width: 768px) {
            .table {
                display: block;
            }
            thead {
                display: none;
            }
            tr {
                display: block;
                margin-bottom: 1em;
                border-bottom: 1px solid var(--table-border);
            }
            td {
                display: block;
                text-align: left;
                padding-left: 50%;
                position: relative;
            }
            td:before {
                content: attr(data-label);
                position: absolute;
                left: 10px;
                width: 45%;
                font-weight: bold;
            }
            .actions {
                display: flex;
                justify-content: space-around;
                flex-wrap: wrap;
            }
        }
        .download-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
<div class="spinner" id="spinner"></div>
<div class="alert alert-warning session-warning" role="alert">
    Your session will expire in 1 minute. <button id="extendSession" class="btn btn-sm btn-primary">Extend</button>
</div>
<div class="container">
    <nav class="navbar">
        <div class="mb-4">
            <a href="/add" class="btn btn-primary" style="background-color: var(--btn-primary-bg)">Add New Activity</a>
            <a href="/confirmExit" class="btn btn-danger">Exit</a>
            <button id="bulkDelete" class="btn btn-danger">Delete Selected</button>
            <button id="bulkEdit" class="btn btn-warning" data-toggle="modal" data-target="#bulkEditModal">Bulk Edit</button>
            <a href="#" id="exportCsv" class="btn btn-success">Export to CSV</a>
            <button id="toggleDarkMode" class="btn btn-secondary">Toggle Dark Mode</button>
            <button id="toggleColumns" class="btn btn-secondary" data-toggle="modal" data-target="#columnModal">Columns</button>
            <button id="toggleAnalytics" class="btn btn-secondary">Simple Analytics</button>
            <a href="/stateCategoryQuery" class="btn btn-info">Query by State & Category</a>
            <a href="/dateRangeQuery" class="btn btn-info">Query by Date Range</a>
        </div>
    </nav>
    <h1 class="text-center mt-4" style="font-family: 'Arial', sans-serif; font-size: 40px; color: var(--btn-primary-bg); font-weight: bold; text-shadow: 2px 2px 5px rgba(0,0,0,0.3);">Activities List</h1>

    <!-- Analytics Dashboard -->
    <div id="analytics-section" class="row mb-4" style="display: none;">
        <div class="col-md-6">
            <canvas id="stateChart" height="200"></canvas>
        </div>
        <div class="col-md-6">
            <canvas id="categoryChart" height="200"></canvas>
        </div>
    </div>

    <!-- Column Selection Modal -->
    <div class="modal fade" id="columnModal" tabindex="-1" role="dialog" aria-labelledby="columnModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="columnModalLabel">Select Columns</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-check">
                        <input class="form-check-input column-toggle" type="checkbox" value="state" id="colState" checked>
                        <label class="form-check-label" for="colState">State</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input column-toggle" type="checkbox" value="stationName" id="colStationName" checked>
                        <label class="form-check-label" for="colStationName">Station Name</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input column-toggle" type="checkbox" value="activityType" id="colActivityType" checked>
                        <label class="form-check-label" for="colActivityType">Activity Type</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input column-toggle" type="checkbox" value="eventCategory" id="colEventCategory" checked>
                        <label class="form-check-label" for="colEventCategory">Event Category</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input column-toggle" type="checkbox" value="participantCategory" id="colParticipantCategory" checked>
                        <label class="form-check-label" for="colParticipantCategory">Participant Category</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input column-toggle" type="checkbox" value="eventDescription" id="colEventDescription" checked>
                        <label class="form-check-label" for="colEventDescription">Event Description</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input column-toggle" type="checkbox" value="schoolOrCollegeOrPanchayatName" id="colSchool" checked>
                        <label class="form-check-label" for="colSchool">School/College/Panchayat Name</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input column-toggle" type="checkbox" value="eventLocation" id="colEventLocation" checked>
                        <label class="form-check-label" for="colEventLocation">Event Location</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input column-toggle" type="checkbox" value="eventDate" id="colEventDate" checked>
                        <label class="form-check-label" for="colEventDate">Event Date</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input column-toggle" type="checkbox" value="numberOfParticipants" id="colParticipants" checked>
                        <label class="form-check-label" for="colParticipants">Number of Participants</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input column-toggle" type="checkbox" value="remarks" id="colRemarks" checked>
                        <label class="form-check-label" for="colRemarks">Remarks</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveColumns">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Edit Modal -->
    <div class="modal fade" id="bulkEditModal" tabindex="-1" role="dialog" aria-labelledby="bulkEditModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bulkEditModalLabel">Bulk Edit Activities</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="bulkEventCategory">Event Category</label>
                        <select id="bulkEventCategory" class="form-control">
                            <option value="">-- Select Category --</option>
                            <option value="Integrity Pledge">Integrity Pledge</option>
                            <option value="Vendors Meet">Vendors Meet</option>
                            <option value="Elocution">Elocution</option>
                            <option value="Debate">Debate</option>
                            <option value="Drawing">Drawing</option>
                            <option value="Quiz">Quiz</option>
                            <option value="Slogan">Slogan</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="bulkEventDate">Event Date</label>
                        <input id="bulkEventDate" class="form-control" placeholder="Select Date">
                    </div>
                    <div class="form-group">
                        <label for="bulkParticipantCategory">Participant Category</label>
                        <input id="bulkParticipantCategory" class="form-control" placeholder="Enter Participant Category">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveBulkEdit">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Activity Table -->
    <table class="table table-bordered table-striped" role="grid" aria-labelledby="activityTableDesc">
        <caption id="activityTableDesc" class="sr-only">List of activities with details and actions</caption>
        <thead>
            <tr>
                <th scope="col" role="columnheader"><input type="checkbox" id="selectAll" aria-label="Select all activities"></th>
                <th scope="col" data-sort="id" role="columnheader" aria-sort="none">ID</th>
                <th scope="col" data-sort="state" data-col="state" role="columnheader" aria-sort="none">State</th>
                <th scope="col" data-sort="stationName" data-col="stationName" role="columnheader" aria-sort="none">Station Name</th>
                <th scope="col" data-sort="activityType" data-col="activityType" role="columnheader" aria-sort="none">Activity Type</th>
                <th scope="col" data-sort="eventCategory" data-col="eventCategory" role="columnheader" aria-sort="none">Event Category</th>
                <th scope="col" data-sort="participantCategory" data-col="participantCategory" role="columnheader" aria-sort="none">Participant Category</th>
                <th scope="col" data-sort="eventDescription" data-col="eventDescription" role="columnheader" aria-sort="none">Event Description</th>
                <th scope="col" data-sort="schoolOrCollegeOrPanchayatName" data-col="schoolOrCollegeOrPanchayatName" role="columnheader" aria-sort="none">School/College/Panchayat Name</th>
                <th scope="col" data-sort="eventLocation" data-col="eventLocation" role="columnheader" aria-sort="none">Event Location</th>
                <th scope="col" data-sort="eventDate" data-col="eventDate" role="columnheader" aria-sort="none">Event Date</th>
                <th scope="col" data-sort="numberOfParticipants" data-col="numberOfParticipants" role="columnheader" aria-sort="none">Number of Participants</th>
                <th scope="col" data-sort="remarks" data-col="remarks" role="columnheader" aria-sort="none">Remarks</th>
                <th scope="col" role="columnheader" class="actions">Actions</th>
            </tr>
        </thead>
        <tbody id="activityTable" data-sort-order="asc">
            <tr th:each="activity : ${activities}">
                <td data-label="Select"><input type="checkbox" class="selectRow" th:value="${activity.id}" aria-label="Select activity"></td>
                <td data-label="ID" th:text="${activity.id}" scope="row" class="activity-id"></td>
                <td data-label="State" contenteditable="true" class="editable" data-field="state" th:text="${activity.state}"></td>
                <td data-label="Station Name" contenteditable="true" class="editable" data-field="stationName" th:text="${activity.stationName}"></td>
                <td data-label="Activity Type" contenteditable="true" class="editable" data-field="activityType" th:text="${activity.activityType}"></td>
                <td data-label="Event Category" contenteditable="true" class="editable" data-field="eventCategory" th:text="${activity.eventCategory}"></td>
                <td data-label="Participant Category" contenteditable="true" class="editable" data-field="participantCategory" th:utext="${activity.participantCategory}"></td>
                <td data-label="Event Description" contenteditable="true" class="editable" data-field="eventDescription" th:utext="${activity.eventDescription}"></td>
                <td data-label="School/College/Panchayat Name" contenteditable="true" class="editable" data-field="schoolOrCollegeOrPanchayatName" th:text="${activity.schoolOrCollegeOrPanchayatName}"></td>
                <td data-label="Event Location" contenteditable="true" class="editable" data-field="eventLocation" th:text="${activity.eventLocation}"></td>
                <td data-label="Event Date" contenteditable="true" class="editable" data-field="eventDate" th:text="${activity.eventDate}"></td>
                <td data-label="Number of Participants" contenteditable="true" class="editable" data-field="numberOfParticipants" th:text="${activity.numberOfParticipants}"></td>
                <td data-label="Remarks" contenteditable="true" class="editable" data-field="remarks" th:utext="${activity.remarks}"></td>
                <td data-label="Actions" class="actions">
                    <button class="btn btn-sm btn-success save-row" th:attr="data-id=${activity.id}" aria-label="Save changes for activity ${activity.id}">Save</button>
                    <a th:href="@{/update/{id}(id=${activity.id})}" class="btn btn-sm btn-warning" aria-label="Edit activity ${activity.id}">Edit</a>
                    <a th:href="@{/confirmDelete/{id}(id=${activity.id})}" class="btn btn-sm btn-danger" aria-label="Delete activity ${activity.id}">Delete</a>
                    <div class="dropdown" th:if="${fileMap.get(activity.id)?.size() > 0}">
                        <button class="btn btn-sm btn-primary download-btn" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" th:attr="data-id=${activity.id}">
                            Download
                        </button>
                        <div class="dropdown-menu">
                            <a class="dropdown-item" th:each="file : ${fileMap.get(activity.id)}" th:href="@{'/api/download/' + ${file.id}}" th:text="${file.fileName}"></a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item text-danger delete-files" th:attr="data-id=${activity.id}">Delete All Images</a>
                        </div>
                    </div>
                    <button class="btn btn-sm btn-primary download-btn" disabled th:unless="${fileMap.get(activity.id)?.size() > 0}" th:attr="data-id=${activity.id}" aria-label="No images available for activity ${activity.id}">Download</button>
                </td>
            </tr>
        </tbody>
    </table>

    <!-- Pagination -->
    <div class="d-flex justify-content-center mt-4">
        <nav aria-label="Page navigation">
            <ul class="pagination">
                <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                    <a class="page-link" th:href="@{/(page=${currentPage - 1},size=${size},sortBy=${sortBy},sortDir=${sortDir})}" aria-label="Previous page">Previous</a>
                </li>
                <li class="page-item" th:each="i : ${#numbers.sequence(0, totalPages - 1)}" th:classappend="${i == currentPage} ? 'active'">
                    <a class="page-link" th:href="@{/(page=${i},size=${size},sortBy=${sortBy},sortDir=${sortDir})}" th:text="${i + 1}" th:attr="aria-label='Page ' + ${i + 1}"></a>
                </li>
                <li class="page-item" th:classappend="${currentPage >= totalPages - 1} ? 'disabled'">
                    <a class="page-link" th:href="@{/(page=${currentPage + 1},size=${size},sortBy=${sortBy},sortDir=${sortDir})}" aria-label="Next page">Next</a>
                </li>
            </ul>
        </nav>
    </div>
</div>

<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.bundle.min.js" integrity="sha384-pjaaA8dDz/5BgdFUPX6M/9SUZv4d12SUPF0axWc+VRZkx5xU3daN+lYb49+Ax+Tl" crossorigin="anonymous"></script>
<script>
    // Initialize theme from localStorage
    if (localStorage.getItem('theme') === 'dark') {
        document.body.setAttribute('data-theme', 'dark');
    }

    // Toggle Dark Mode
    document.getElementById('toggleDarkMode').addEventListener('click', () => {
        const body = document.body;
        const theme = body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        body.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
    });

    // Show/Hide Spinner
    function showSpinner() {
        document.getElementById('spinner').style.display = 'block';
    }
    function hideSpinner() {
        document.getElementById('spinner').style.display = 'none';
    }

    // Initialize Select2 for Bulk Edit Modal
    $('#bulkEventCategory').select2({
        placeholder: 'Select options',
        allowClear: true
    });

    // Initialize Flatpickr for Bulk Edit
    flatpickr('#bulkEventDate', {
        dateFormat: 'Y-m-d'
    });

    // Sorting Functionality
    document.querySelectorAll('th[data-sort]').forEach(th => {
        th.addEventListener('click', () => {
            const sortField = th.dataset.sort;
            const currentSort = th.getAttribute('aria-sort');
            const newSortDir = currentSort === 'ascending' ? 'descending' : 'ascending';
            document.querySelectorAll('th').forEach(header => {
                header.setAttribute('aria-sort', 'none');
                header.classList.remove('sort-asc', 'sort-desc');
            });
            th.setAttribute('aria-sort', newSortDir);
            th.classList.add(newSortDir === 'ascending' ? 'sort-asc' : 'sort-desc');
            const size = new URLSearchParams(window.location.search).get('size') || 10;
            window.location.href = `/?page=0&size=${size}&sortBy=${sortField}&sortDir=${newSortDir === 'ascending' ? 'asc' : 'desc'}`;
        });
    });

    // Inline Editing
    document.querySelectorAll('.save-row').forEach(button => {
        button.addEventListener('click', () => {
            const row = button.closest('tr');
            const id = button.dataset.id;
            const data = {
                id: id,
                state: row.querySelector('[data-field="state"]').textContent,
                stationName: row.querySelector('[data-field="stationName"]').textContent,
                activityType: row.querySelector('[data-field="activityType"]').textContent,
                eventCategory: row.querySelector('[data-field="eventCategory"]').textContent,
                participantCategory: row.querySelector('[data-field="participantCategory"]').textContent,
                eventDescription: row.querySelector('[data-field="eventDescription"]').innerHTML,
                schoolOrCollegeOrPanchayatName: row.querySelector('[data-field="schoolOrCollegeOrPanchayatName"]').textContent,
                eventLocation: row.querySelector('[data-field="eventLocation"]').textContent,
                eventDate: row.querySelector('[data-field="eventDate"]').textContent,
                numberOfParticipants: parseInt(row.querySelector('[data-field="numberOfParticipants"]').textContent) || 0,
                remarks: row.querySelector('[data-field="remarks"]').innerHTML
            };
            showSpinner();
            $.ajax({
                url: '/save',
                method: 'POST',
                contentType: 'application/x-www-form-urlencoded',
                data: $.param(data),
                success: () => {
                    alert('Activity updated successfully!');
                },
                error: (xhr) => {
                    alert('Failed to update activity: ' + (xhr.responseJSON?.message || 'Unknown error'));
                },
                complete: hideSpinner
            });
        });
    });

    // Bulk Edit
    document.getElementById('saveBulkEdit').addEventListener('click', () => {
        const selected = Array.from(document.querySelectorAll('.selectRow:checked')).map(cb => cb.value);
        if (selected.length === 0) {
            alert('Please select at least one activity to edit.');
            return;
        }
        const eventCategory = document.getElementById('bulkEventCategory').value;
        const eventDate = document.getElementById('bulkEventDate').value;
        const participantCategory = document.getElementById('bulkParticipantCategory').value;
        const updates = {};
        if (eventCategory) updates.eventCategory = eventCategory;
        if (eventDate) updates.eventDate = eventDate;
        if (participantCategory) updates.participantCategory = participantCategory;
        if (Object.keys(updates).length === 0) {
            alert('Please provide at least one field to update.');
            return;
        }
        showSpinner();
        $.ajax({
            url: '/activities/bulk-update',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ ids: selected, updates: updates }),
            success: () => {
                alert('Activities updated successfully!');
                $('#bulkEditModal').modal('hide');
                window.location.reload();
            },
            error: (xhr) => {
                alert('Failed to update activities: ' + (xhr.responseJSON?.message || 'Unknown error'));
            },
            complete: hideSpinner
        });
    });

    // Bulk Delete
    document.getElementById('bulkDelete').addEventListener('click', () => {
        const selected = Array.from(document.querySelectorAll('.selectRow:checked')).map(cb => cb.value);
        if (selected.length === 0) {
            alert('Please select at least one activity to delete.');
            return;
        }
        if (confirm(`Are you sure you want to delete ${selected.length} activities?`)) {
            showSpinner();
            $.ajax({
                url: '/activities/delete',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(selected),
                success: () => {
                    window.location.reload();
                },
                error: () => {
                    alert('Failed to delete activities.');
                },
                complete: hideSpinner
            });
        }
    });

    // Select All Checkbox
    document.getElementById('selectAll').addEventListener('change', (e) => {
        document.querySelectorAll('.selectRow').forEach(cb => cb.checked = e.target.checked);
    });

    // Export to CSV
    document.getElementById('exportCsv').addEventListener('click', () => {
        const rows = [];
        const headers = Array.from(document.querySelectorAll('th[data-col]')).map(th => th.dataset.col);
        rows.push(headers.join(','));
        document.querySelectorAll('#activityTable tr').forEach(row => {
            const cells = Array.from(row.querySelectorAll('td.editable')).map(cell => `"${cell.textContent.replace(/"/g, '""')}"`);
            if (cells.length > 0) {
                rows.push(cells.join(','));
            }
        });
        const csv = rows.join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'activities.csv';
        a.click();
        window.URL.revokeObjectURL(url);
    });

    // Column Toggling
    document.getElementById('saveColumns').addEventListener('click', () => {
        const visibleColumns = Array.from(document.querySelectorAll('.column-toggle:checked')).map(cb => cb.value);
        localStorage.setItem('visibleColumns', JSON.stringify(visibleColumns));
        applyColumnVisibility();
        $('#columnModal').modal('hide');
    });

    function applyColumnVisibility() {
        const visibleColumns = JSON.parse(localStorage.getItem('visibleColumns')) || 
                              ['state', 'stationName', 'activityType', 'eventCategory', 'participantCategory', 
                               'eventDescription', 'schoolOrCollegeOrPanchayatName', 'eventLocation', 
                               'eventDate', 'numberOfParticipants', 'remarks'];
        document.querySelectorAll('th[data-col], td[data-field]').forEach(el => {
            const col = el.dataset.col || el.dataset.field;
            el.style.display = visibleColumns.includes(col) ? '' : 'none';
        });
    }
    applyColumnVisibility();

    // Analytics Toggle
    let stateChart, categoryChart;
    document.getElementById('toggleAnalytics').addEventListener('click', () => {
        const analyticsSection = document.getElementById('analytics-section');
        const isVisible = analyticsSection.style.display !== 'none';
        analyticsSection.style.display = isVisible ? 'none' : 'block';
        if (!isVisible && !stateChart) {
            initializeCharts();
        }
    });

    function initializeCharts() {
        const activities = Array.from(document.querySelectorAll('#activityTable tr')).map(row => ({
            state: row.querySelector('[data-field="state"]').textContent,
            eventCategory: row.querySelector('[data-field="eventCategory"]').textContent
        }));

        const stateCounts = activities.reduce((acc, act) => {
            acc[act.state] = (acc[act.state] || 0) + 1;
            return acc;
        }, {});
        const categoryCounts = activities.reduce((acc, act) => {
            acc[act.eventCategory] = (acc[act.eventCategory] || 0) + 1;
            return acc;
        }, {});

        stateChart = new Chart(document.getElementById('stateChart'), {
            type: 'bar',
            data: {
                labels: Object.keys(stateCounts),
                datasets: [{
                    label: 'Activities by State',
                    data: Object.values(stateCounts),
                    backgroundColor: ['rgba(54, 162, 235, 0.6)', 'rgba(100, 181, 246, 0.6)', 'rgba(153, 204, 255, 0.6)'],
                    borderColor: ['rgba(54, 162, 235, 1)', 'rgba(100, 181, 246, 1)', 'rgba(153, 204, 255, 1)'],
                    borderWidth: 1
                }]
            },
            options: {
                scales: { y: { beginAtZero: true } }
            }
        });

        categoryChart = new Chart(document.getElementById('categoryChart'), {
            type: 'pie',
            data: {
                labels: Object.keys(categoryCounts),
                datasets: [{
                    label: 'Activities by Category',
                    data: Object.values(categoryCounts),
                    backgroundColor: ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEEAD', '#D4A5A5', '#9B59B6']
                }]
            }
        });
    }

    // Delete All Images
    document.querySelectorAll('.delete-files').forEach(button => {
        button.addEventListener('click', () => {
            const activityId = button.dataset.id;
            if (confirm('Are you sure you want to delete all images for this activity?')) {
                showSpinner();
                fetch(`/activities/files/${activityId}`, {
                    method: 'DELETE'
                }).then(response => {
                    if (response.ok) {
                        const dropdown = button.closest('.dropdown');
                        const disabledButton = dropdown.parentElement.querySelector('.download-btn[disabled]');
                        dropdown.remove();
                        if (disabledButton) {
                            disabledButton.style.display = 'block';
                        }
                        alert('All images deleted successfully!');
                    } else {
                        alert('Failed to delete images.');
                    }
                }).catch(error => {
                    console.error('Delete images failed:', error);
                    alert('Failed to delete images.');
                }).finally(hideSpinner);
            }
        });
    });

    // Server-Sent Events for Real-Time Updates
    const eventSource = new EventSource('/activities/updates');
    eventSource.onmessage = function(event) {
        const data = JSON.parse(event.data);
        if (data.action === 'HEARTBEAT') return;

        if (data.action === 'ADD' || data.action === 'UPDATE') {
            const row = document.querySelector(`tr .activity-id:contains('${data.activity.id}')`);
            const files = data.files || [];
            const downloadCell = row ? row.querySelector('.actions') : null;
            if (row && data.action === 'UPDATE') {
                row.querySelector('[data-field="state"]').textContent = data.activity.state;
                row.querySelector('[data-field="stationName"]').textContent = data.activity.stationName;
                row.querySelector('[data-field="activityType"]').textContent = data.activity.activityType;
                row.querySelector('[data-field="eventCategory"]').textContent = data.activity.eventCategory;
                row.querySelector('[data-field="participantCategory"]').textContent = data.activity.participantCategory;
                row.querySelector('[data-field="eventDescription"]').innerHTML = data.activity.eventDescription;
                row.querySelector('[data-field="schoolOrCollegeOrPanchayatName"]').textContent = data.activity.schoolOrCollegeOrPanchayatName;
                row.querySelector('[data-field="eventLocation"]').textContent = data.activity.eventLocation;
                row.querySelector('[data-field="eventDate"]').textContent = data.activity.eventDate;
                row.querySelector('[data-field="numberOfParticipants"]').textContent = data.activity.numberOfParticipants;
                row.querySelector('[data-field="remarks"]').innerHTML = data.activity.remarks;

                if (downloadCell) {
                    const existingDropdown = downloadCell.querySelector('.dropdown');
                    const disabledButton = downloadCell.querySelector('.download-btn[disabled]');
                    if (files.length > 0) {
                        if (existingDropdown) {
                            existingDropdown.querySelector('.dropdown-menu').innerHTML = files.map(file => 
                                `<a class="dropdown-item" href="/api/download/${file.id}">${file.fileName}</a>`
                            ).join('') + '<div class="dropdown-divider"></div><a class="dropdown-item text-danger delete-files" data-id="' + data.activity.id + '">Delete All Images</a>';
                        } else {
                            const dropdown = document.createElement('div');
                            dropdown.className = 'dropdown';
                            dropdown.innerHTML = `
                                <button class="btn btn-sm btn-primary download-btn" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" data-id="${data.activity.id}">
                                    Download
                                </button>
                                <div class="dropdown-menu">
                                    ${files.map(file => `<a class="dropdown-item" href="/api/download/${file.id}">${file.fileName}</a>`).join('')}
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item text-danger delete-files" data-id="${data.activity.id}">Delete All Images</a>
                                </div>`;
                            if (disabledButton) disabledButton.remove();
                            downloadCell.appendChild(dropdown);
                        }
                    } else {
                        if (existingDropdown) existingDropdown.remove();
                        if (!disabledButton) {
                            const disabledBtn = document.createElement('button');
                            disabledBtn.className = 'btn btn-sm btn-primary download-btn';
                            disabledBtn.disabled = true;
                            disabledBtn.textContent = 'Download';
                            disabledBtn.dataset.id = data.activity.id;
                            disabledBtn.setAttribute('aria-label', `No images available for activity ${data.activity.id}`);
                            downloadCell.appendChild(disabledBtn);
                        }
                    }
                }
            } else if (data.action === 'ADD') {
                window.location.reload();
            }
        } else if (data.action === 'DELETE') {
            data.deletedIds.forEach(id => {
                const row = document.querySelector(`tr .activity-id:contains('${id}')`);
                if (row) row.remove();
            });
        }
    };
    eventSource.onerror = function() {
        console.error('SSE connection error');
        eventSource.close();
        setTimeout(() => {
            window.location.reload();
        }, 5000);
    };

    // Session Timeout Warning
    let timeoutId;
    function resetSessionTimer() {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => {
            document.querySelector('.session-warning').style.display = 'block';
            setTimeout(() => {
                window.location.href = '/';
            }, 60000);
        }, 15 * 60 * 1000);
    }
    document.getElementById('extendSession').addEventListener('click', () => {
        document.querySelector('.session-warning').style.display = 'none';
        resetSessionTimer();
        fetch('/extend-session', { method: 'POST' })
            .catch(error => console.error('Session extension failed:', error));
    });
    document.addEventListener('mousemove', resetSessionTimer);
    document.addEventListener('keydown', resetSessionTimer);
    resetSessionTimer();
</script>
</body>
</html>