<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Query by Date Range</title>
    <!-- Tailwind CSS for vibrant, responsive design -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Flatpickr for modern date picker -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <style>
        body {
            transition: background-color 0.3s, color 0.3s;
            font-family: 'Inter', sans-serif;
        }
        .dark {
            background: linear-gradient(135deg, #1e3a8a, #4c1d95);
            color: #e0f2fe;
        }
        .light {
            background: linear-gradient(135deg, #3b82f6, #a855f7);
            color: #1e293b;
        }
        .table-header {
            background: linear-gradient(90deg, #3b82f6, #22d3ee);
            transition: background 0.3s;
        }
        .dark .table-header {
            background: linear-gradient(90deg, #1e40af, #0ea5e9);
        }
        .table-header:hover {
            background: linear-gradient(90deg, #2563eb, #06b6d4);
            cursor: pointer;
            transform: scale(1.02);
        }
        .dark .table-header:hover {
            background: linear-gradient(90deg, #1e3a8a, #0284c7);
        }
        .sort-icon::after {
            content: '↕';
            margin-left: 0.5rem;
            color: #fef3c7;
        }
        .sort-asc::after {
            content: '↑';
        }
        .sort-desc::after {
            content: '↓';
        }
        .form-container {
            background: linear-gradient(135deg, #f97316, #ef4444);
            border: 2px solid #facc15;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        .dark .form-container {
            background: linear-gradient(135deg, #7c3aed, #db2777);
            border: 2px solid #a5b4fc;
        }
        .btn-primary {
            background: linear-gradient(90deg, #22d3ee, #10b981);
            transition: transform 0.2s, background 0.3s;
        }
        .btn-primary:hover {
            background: linear-gradient(90deg, #06b6d4, #059669);
            transform: scale(1.05);
        }
        .btn-secondary {
            background: linear-gradient(90deg, #f97316, #ef4444);
            transition: transform 0.2s, background 0.3s;
        }
        .btn-secondary:hover {
            background: linear-gradient(90deg, #ea580c, #dc2626);
            transform: scale(1.05);
        }
        .query-row {
            transition: transform 0.2s;
        }
        .query-row:hover {
            transform: translateY(-2px);
        }
        .history-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        .pagination {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .pagination button {
            padding: 5px 10px;
            cursor: pointer;
        }
        .performance-metrics {
            margin-top: 10px;
            font-size: 0.9em;
            color: #666;
        }
        .dark .performance-metrics {
            color: #ccc;
        }
    </style>
</head>
<body class="min-h-screen light dark:text-sky-100 flex flex-col">
    <!-- Header -->
    <header class="bg-gradient-to-r from-indigo-500 to-purple-600 p-4">
        <div class="container mx-auto flex justify-between items-center">
            <a href="/activity" class="text-2xl font-bold text-yellow-300 hover:text-yellow-200 transition">Back to Home</a>
            <button id="theme-toggle" class="text-white bg-gradient-to-r from-gray-700 to-gray-500 dark:from-gray-600 dark:to-gray-400 px-4 py-2 rounded-lg font-semibold hover:from-gray-800 hover:to-gray-600">
                Toggle Theme
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-6 flex-grow">
        <h1 class="text-4xl font-extrabold mb-6 text-yellow-300 drop-shadow">Query by Date Range</h1>

        <!-- Query Form -->
        <form id="query-form" class="form-container mb-8 p-6 rounded-xl">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="startDate" class="block text-lg font-semibold text-white">Start Date</label>
                    <input type="text" id="startDate" name="startDate" placeholder="YYYY-MM-DD" class="flatpickr w-full p-3 border-2 border-yellow-300 rounded-lg bg-white/90 dark:bg-gray-600/90 dark:border-indigo-300 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-cyan-400" required>
                    <p id="startDate-error" class="text-pink-400 text-sm mt-1 hidden"></p>
                </div>
                <div>
                    <label for="endDate" class="block text-lg font-semibold text-white">End Date</label>
                    <input type="text" id="endDate" name="endDate" placeholder="YYYY-MM-DD" class="flatpickr w-full p-3 border-2 border-yellow-300 rounded-lg bg-white/90 dark:bg-gray-600/90 dark:border-indigo-300 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-cyan-400" required>
                    <p id="endDate-error" class="text-pink-400 text-sm mt-1 hidden"></p>
                </div>
            </div>

            <!-- Advanced Filters -->
            <div class="mt-6">
                <h3 class="text-2xl font-bold text-white mb-4">Advanced Filters</h3>
                <div class="grid grid-cols-183 md:grid-cols-4 gap-6">
                    <div>
                        <label for="state" class="block text-lg font-semibold text-white">State</label>
                        <select id="state" name="state" class="w-full p-3 border-2 border-yellow-300 rounded-lg bg-white/90 dark:bg-gray-600/90 dark:border-indigo-300 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-cyan-400">
                            <option value="">All States</option>
                            <option value="Andhra Pradesh">Andhra Pradesh</option>
                            <option value="Telangana">Telangana</option>
                            <option value="Karnataka">Karnataka</option>
                        </select>
                    </div>
                    <div>
                        <label for="activityType" class="block text-lg font-semibold text-white">Activity Type</label>
                        <select id="activityType" name="activityType" class="w-full p-3 border-2 border-yellow-300 rounded-lg bg-white/90 dark:bg-gray-600/90 dark:border-indigo-300 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-cyan-400">
                            <option value="">All Activity Types</option>
                            <option value="In House">In House</option>
                            <option value="Outreach">Outreach</option>
                        </select>
                    </div>
                    <div>
                        <label for="eventCategory" class="block text-lg font-semibold text-white">Event Category</label>
                        <select id="eventCategory" name="eventCategory" class="w-full p-3 border-2 border-yellow-300 rounded-lg bg-white/90 dark:bg-gray-600/90 dark:border-indigo-300 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-cyan-400">
                            <option value="">All Event Categories</option>
                            <option value="Integrity Pledge">Integrity Pledge</option>
                            <option value="Vendors Meet">Vendors Meet</option>
                            <option value="Elocution">Elocution</option>
                            <option value="Debate">Debate</option>
                            <option value="Drawing">Drawing</option>
                            <option value="Quiz">Quiz</option>
                            <option value="Slogan">Slogan</option>
                        </select>
                    </div>
                    <div>
                        <label for="filterOperator" class="block text-lg font-semibold text-white">Filter Operator</label>
                        <select id="filterOperator" name="filterOperator" class="w-full p-3 border-2 border-yellow-300 rounded-lg bg-white/90 dark:bg-gray-600/90 dark:border-indigo-300 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-cyan-400">
                            <option value="AND">AND</option>
                            <option value="OR">OR</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Dynamic Query Builder -->
            <div class="mt-6">
                <h3 class="text-2xl font-bold text-white mb-4">Dynamic Query Builder</h3>
                <div id="query-builder" class="space-y-4">
                    <div class="query-row flex flex-col md:flex-row gap-4 items-center bg-white/10 dark:bg-gray-700/50 p-4 rounded-lg">
                        <select name="field" class="field w-full md:w-1/5 p-3 border-2 border-yellow-300 rounded-lg bg-white/90 dark:bg-gray-600/90 dark:border-indigo-300 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-cyan-400">
                            <option value="state">State</option>
                            <option value="activityType">Activity Type</option>
                            <option value="eventCategory">Event Category</option>
                            <option value="numberOfParticipants">Number of Participants</option>
                        </select>
                        <select name="operator" class="operator w-full md:w-1/5 p-3 border-2 border-yellow-300 rounded-lg bg-white/90 dark:bg-gray-600/90 dark:border-indigo-300 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-cyan-400">
                            <option value="=">=</option>
                            <option value="!=">!=</option>
                            <option value="<">&lt;</option>
                            <option value=">">&gt;</option>
                        </select>
                        <select name="value" class="value w-full md:w-1/5 p-3 border-2 border-yellow-300 rounded-lg bg-white/90 dark:bg-gray-600/90 dark:border-indigo-300 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-cyan-400">
                            <option value="">Select Value</option>
                        </select>
                        <select name="logical" class="logical w-full md:w-1/5 p-3 border-2 border-yellow-300 rounded-lg bg-white/90 dark:bg-gray-600/90 dark:border-indigo-300 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-cyan-400">
                            <option value="AND">AND</option>
                            <option value="OR">OR</option>
                            <option value="NOT">NOT</option>
                        </select>
                        <button type="button" class="remove-row btn-secondary text-white px-4 py-2 rounded-lg font-semibold">Remove</button>
                    </div>
                </div>
                <button type="button" id="add-query-row" class="mt-4 btn-primary text-white px-4 py-2 rounded-lg font-semibold">Add Condition</button>
            </div>

            <!-- Buttons -->
            <div class="mt-6 flex gap-4">
                <button type="submit" class="btn-primary text-white px-6 py-3 rounded-lg font-semibold text-lg">Run Query</button>
                <button type="button" id="clear-form" class="btn-secondary text-white px-6 py-3 rounded-lg font-semibold text-lg">Clear</button>
            </div>

            <!-- SQL Preview -->
            <div class="mt-6">
                <h3 class="text-2xl font-bold text-white mb-4">SQL Query Preview</h3>
                <pre id="sql-preview" class="bg-white/10 dark:bg-gray-700/50 p-4 rounded-lg text-sm text-cyan-300 overflow-x-auto font-mono">SELECT * FROM activity WHERE event_date BETWEEN 'YYYY-MM-DD' AND 'YYYY-MM-DD';</pre>
            </div>
        </form>

        <!-- Query History -->
        <div class="mb-8">
            <h3 class="text-2xl font-bold text-yellow-300 mb-4">Query History</h3>
            <ul id="query-history" class="space-y-2"></ul>
        </div>

        <!-- Results Table -->
        <div id="results" class="overflow-x-auto">
            <h2 class="text-3xl font-bold text-yellow-300 mb-4">List of Activities</h2>
            <div class="performance-metrics" id="performanceMetrics"></div>
            <table class="w-full border-collapse bg-white/90 dark:bg-gray-700/90 shadow-lg rounded-lg">
                <thead>
                    <tr class="text-white">
                        <th class="table-header p-3 border border-yellow-300 font-semibold" data-sort="id">ID<span class="sort-icon"></span></th>
                        <th class="table-header p-3 border border-yellow-300 font-semibold" data-sort="state">State<span class="sort-icon"></span></th>
                        <th class="table-header p-3 border border-yellow-300 font-semibold" data-sort="stationName">Station Name<span class="sort-icon"></span></th>
                        <th class="table-header p-3 border border-yellow-300 font-semibold" data-sort="activityType">Activity Type<span class="sort-icon"></span></th>
                        <th class="table-header p-3 border border-yellow-300 font-semibold" data-sort="eventCategory">Event Category<span class="sort-icon"></span></th>
                        <th class="table-header p-3 border border-yellow-300 font-semibold" data-sort="participantCategory">Participant Category<span class="sort-icon"></span></th>
                        <th class="table-header p-3 border border-yellow-300 font-semibold" data-sort="eventDescription">Event Description<span class="sort-icon"></span></th>
                        <th class="table-header p-3 border border-yellow-300 font-semibold" data-sort="schoolOrCollegeOrPanchayatName">School/College/Panchayat Name<span class="sort-icon"></span></th>
                        <th class="table-header p-3 border border-yellow-300 font-semibold" data-sort="eventLocation">Event Location<span class="sort-icon"></span></th>
                        <th class="table-header p-3 border border-yellow-300 font-semibold" data-sort="eventDate">Event Date<span class="sort-icon"></span></th>
                        <th class="table-header p-3 border border-yellow-300 font-semibold" data-sort="numberOfParticipants">Number of Participants<span class="sort-icon"></span></th>
                        <th class="table-header p-3 border border-yellow-300 font-semibold" data-sort="remarks">Remarks<span class="sort-icon"></span></th>
                    </tr>
                </thead>
                <tbody id="activity-table-body" class="text-gray-800 dark:text-gray-200">
                    <tr><td colspan="12" class="p-3 text-center font-semibold">No activities found</td></tr>
                </tbody>
            </table>
            <div class="pagination" id="pagination"></div>
        </div>
    </main>

    <script>
    let activities = [];
    let currentPage = 1;
    const rowsPerPage = 10;
    let sortField = "id";
    let sortDir = "asc";

    // Initialize Flatpickr
    flatpickr(".flatpickr", {
        dateFormat: "Y-m-d",
        allowInput: true,
        theme: "confetti"
    });

    // Theme toggle
    const themeToggle = document.getElementById("theme-toggle");
    themeToggle.addEventListener("click", () => {
        document.documentElement.classList.toggle("dark");
        document.body.classList.toggle("light");
        document.body.classList.toggle("dark");
        localStorage.setItem("theme", document.documentElement.classList.contains("dark") ? "dark" : "light");
    });
    if (localStorage.getItem("theme") === "dark") {
        document.documentElement.classList.add("dark");
        document.body.classList.add("dark");
        document.body.classList.remove("light");
    } else {
        document.body.classList.add("light");
    }

    // Input validation
    const startDateInput = document.getElementById("startDate");
    const endDateInput = document.getElementById("endDate");
    const startDateError = document.getElementById("startDate-error");
    const endDateError = document.getElementById("endDate-error");

    function validateDates() {
        startDateError.classList.add("hidden");
        endDateError.classList.add("hidden");
        let isValid = true;
        const startDate = startDateInput.value;
        const endDate = endDateInput.value;
        try {
            if (startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                if (start > end) {
                    endDateError.textContent = "End date must be after start date!";
                    endDateError.classList.remove("hidden");
                    isValid = false;
                }
            }
        } catch (e) {
            startDateError.textContent = "Invalid date format! Use YYYY-MM-DD";
            startDateError.classList.remove("hidden");
            isValid = false;
        }
        return isValid;
    }

    startDateInput.addEventListener("input", validateDates);
    endDateInput.addEventListener("input", validateDates);

    // Clear form
    document.getElementById("clear-form").addEventListener("click", () => {
        document.getElementById("query-form").reset();
        document.getElementById("query-builder").innerHTML = `
            <div class="query-row flex flex-col md:flex-row gap-4 items-center bg-white/10 dark:bg-gray-700/50 p-4 rounded-lg">
                <select name="field" class="field w-full md:w-1/5 p-3 border-2 border-yellow-300 rounded-lg bg-white/90 dark:bg-gray-600/90 dark:border-indigo-300 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-cyan-400">
                    <option value="state">State</option>
                    <option value="activityType">Activity Type</option>
                    <option value="eventCategory">Event Category</option>
                    <option value="numberOfParticipants">Number of Participants</option>
                </select>
                <select name="operator" class="operator w-full md:w-1/5 p-3 border-2 border-yellow-300 rounded-lg bg-white/90 dark:bg-gray-600/90 dark:border-indigo-300 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-cyan-400">
                    <option value="=">=</option>
                    <option value="!=">!=</option>
                    <option value="<">&lt;</option>
                    <option value=">">&gt;</option>
                </select>
                <input type="text" name="value" class="value w-full md:w-1/5 p-3 border-2 border-yellow-300 rounded-lg bg-white/90 dark:bg-gray-600/90 dark:border-indigo-300 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-cyan-400" placeholder="Value">
                <select name="logical" class="logical w-full md:w-1/5 p-3 border-2 border-yellow-300 rounded-lg bg-white/90 dark:bg-gray-600/90 dark:border-indigo-300 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-cyan-400">
                    <option value="AND">AND</option>
                    <option value="OR">OR</option>
                    <option value="NOT">NOT</option>
                </select>
                <button type="button" class="remove-row btn-secondary text-white px-4 py-2 rounded-lg font-semibold">Remove</button>
            </div>`;
        startDateError.classList.add("hidden");
        endDateError.classList.add("hidden");
        document.getElementById("activity-table-body").innerHTML = `<tr><td colspan="12" class="p-3 text-center font-semibold">No activities found</td></tr>`;
        activities = [];
        currentPage = 1;
        renderPagination();
        updatePerformanceMetrics();
        updateSQLPreview();
    });

    // Dynamic query builder
    document.getElementById("add-query-row").addEventListener("click", () => {
        const queryRow = document.createElement("div");
        queryRow.className = "query-row flex flex-col md:flex-row gap-4 items-center bg-white/10 dark:bg-gray-700/50 p-4 rounded-lg";
        queryRow.innerHTML = `
            <select name="field" class="field w-full md:w-1/5 p-3 border-2 border-yellow-300 rounded-lg bg-white/90 dark:bg-gray-600/90 dark:border-indigo-300 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-cyan-400">
                <option value="state">State</option>
                <option value="activityType">Activity Type</option>
                <option value="eventCategory">Event Category</option>
                <option value="numberOfParticipants">Number of Participants</option>
            </select>
            <select name="operator" class="operator w-full md:w-1/5 p-3 border-2 border-yellow-300 rounded-lg bg-white/90 dark:bg-gray-600/90 dark:border-indigo-300 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-cyan-400">
                <option value="=">=</option>
                <option value="!=">!=</option>
                <option value="<">&lt;</option>
                <option value=">">&gt;</option>
            </select>
            <input type="text" name="value" class="value w-full md:w-1/5 p-3 border-2 border-yellow-300 rounded-lg bg-white/90 dark:bg-gray-600/90 dark:border-indigo-300 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-cyan-400" placeholder="Value">
            <select name="logical" class="logical w-full md:w-1/5 p-3 border-2 border-yellow-300 rounded-lg bg-white/90 dark:bg-gray-600/90 dark:border-indigo-300 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-cyan-400">
                <option value="AND">AND</option>
                <option value="OR">OR</option>
                <option value="NOT">NOT</option>
            </select>
            <button type="button" class="remove-row btn-secondary text-white px-4 py-2 rounded-lg font-semibold">Remove</button>`;
        document.getElementById("query-builder").appendChild(queryRow);
        updateSQLPreview();
    });

    document.getElementById("query-builder").addEventListener("click", (e) => {
        if (e.target.classList.contains("remove-row")) {
            e.target.parentElement.remove();
            updateSQLPreview();
        }
    });

    // Populate filter dropdowns
    async function populateFilters() {
        try {
            const response = await fetch("/api/filters");
            const filters = await response.json();
            const stateSelect = document.getElementById("state");
            const activityTypeSelect = document.getElementById("activityType");
            const eventCategorySelect = document.getElementById("eventCategory");
            filters.states.forEach(state => {
                stateSelect.innerHTML += `<option value="${state}">${state}</option>`;
            });
            filters.activityTypes.forEach(type => {
                activityTypeSelect.innerHTML += `<option value="${type}">${type}</option>`;
            });
            filters.eventCategories.forEach(category => {
                eventCategorySelect.innerHTML += `<option value="${category}">${category}</option>`;
            });
        } catch (error) {
            console.error("Error fetching filters:", error);
        }
    }
    populateFilters();

    // Query history
    let queryHistory = JSON.parse(localStorage.getItem("queryHistory")) || [];
    function updateQueryHistory() {
        const list = document.getElementById("query-history");
        list.innerHTML = "";
        queryHistory.forEach((query, index) => {
            const li = document.createElement("li");
            li.className = "history-item p-2 rounded-lg transition";
            li.innerHTML = `<a href="#" class="text-cyan-400 hover:text-cyan-300 font-semibold" data-index="${index}">
                ${query.startDate} to ${query.endDate} ${query.filters ? JSON.stringify(query.filters) : ""}
                ${query.conditions ? JSON.stringify(query.conditions) : ""}
            </a>`;
            list.appendChild(li);
        });
    }
    updateQueryHistory();

    document.getElementById("query-history").addEventListener("click", (e) => {
        if (e.target.tagName === "A") {
            e.preventDefault();
            const index = e.target.dataset.index;
            const query = queryHistory[index];
            document.getElementById("startDate").value = query.startDate;
            document.getElementById("endDate").value = query.endDate;
            document.getElementById("state").value = query.filters?.state || "";
            document.getElementById("activityType").value = query.filters?.activityType || "";
            document.getElementById("eventCategory").value = query.filters?.eventCategory || "";
            document.getElementById("filterOperator").value = query.filters?.filterOperator || "AND";
            const queryBuilder = document.getElementById("query-builder");
            queryBuilder.innerHTML = "";
            if (query.conditions && query.conditions.length > 0) {
                query.conditions.forEach(condition => {
                    const queryRow = document.createElement("div");
                    queryRow.className = "query-row flex flex-col md:flex-row gap-4 items-center bg-white/10 dark:bg-gray-700/50 p-4 rounded-lg";
                    queryRow.innerHTML = `
                        <select name="field" class="field w-full md:w-1/5 p-3 border-2 border-yellow-300 rounded-lg bg-white/90 dark:bg-gray-600/90 dark:border-indigo-300 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-cyan-400">
                            <option value="state" ${condition.field === "state" ? "selected" : ""}>State</option>
                            <option value="activityType" ${condition.field === "activityType" ? "selected" : ""}>Activity Type</option>
                            <option value="eventCategory" ${condition.field === "eventCategory" ? "selected" : ""}>Event Category</option>
                            <option value="numberOfParticipants" ${condition.field === "numberOfParticipants" ? "selected" : ""}>Number of Participants</option>
                        </select>
                        <select name="operator" class="operator w-full md:w-1/5 p-3 border-2 border-yellow-300 rounded-lg bg-white/90 dark:bg-gray-600/90 dark:border-indigo-300 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-cyan-400">
                            <option value="=" ${condition.operator === "=" ? "selected" : ""}>=</option>
                            <option value="!=" ${condition.operator === "!=" ? "selected" : ""}>!=</option>
                            <option value="<" ${condition.operator === "<" ? "selected" : ""}>&lt;</option>
                            <option value=">" ${condition.operator === ">" ? "selected" : ""}>&gt;</option>
                        </select>
                        <input type="text" name="value" class="value w-full md:w-1/5 p-3 border-2 border-yellow-300 rounded-lg bg-white/90 dark:bg-gray-600/90 dark:border-indigo-300 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-cyan-400" placeholder="Value" value="${condition.value}">
                        <select name="logical" class="logical w-full md:w-1/5 p-3 border-2 border-yellow-300 rounded-lg bg-white/90 dark:bg-gray-600/90 dark:border-indigo-300 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-cyan-400">
                            <option value="AND" ${condition.logical === "AND" ? "selected" : ""}>AND</option>
                            <option value="OR" ${condition.logical === "OR" ? "selected" : ""}>OR</option>
                            <option value="NOT" ${condition.logical === "NOT" ? "selected" : ""}>NOT</option>
                        </select>
                        <button type="button" class="remove-row btn-secondary text-white px-4 py-2 rounded-lg font-semibold">Remove</button>`;
                    queryBuilder.appendChild(queryRow);
                });
            } else {
                queryBuilder.innerHTML = `
                    <div class="query-row flex flex-col md:flex-row gap-4 items-center bg-white/10 dark:bg-gray-700/50 p-4 rounded-lg">
                        <select name="field" class="field w-full md:w-1/5 p-3 border-2 border-yellow-300 rounded-lg bg-white/90 dark:bg-gray-600/90 dark:border-indigo-300 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-cyan-400">
                            <option value="state">State</option>
                            <option value="activityType">Activity Type</option>
                            <option value="eventCategory">Event Category</option>
                            <option value="numberOfParticipants">Number of Participants</option>
                        </select>
                        <select name="operator" class="operator w-full md:w-1/5 p-3 border-2 border-yellow-300 rounded-lg bg-white/90 dark:bg-gray-600/90 dark:border-indigo-300 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-cyan-400">
                            <option value="=">=</option>
                            <option value="!=">!=</option>
                            <option value="<">&lt;</option>
                            <option value=">">&gt;</option>
                        </select>
                        <input type="text" name="value" class="value w-full md:w-1/5 p-3 border-2 border-yellow-300 rounded-lg bg-white/90 dark:bg-gray-600/90 dark:border-indigo-300 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-cyan-400" placeholder="Value">
                        <select name="logical" class="logical w-full md:w-1/5 p-3 border-2 border-yellow-300 rounded-lg bg-white/90 dark:bg-gray-600/90 dark:border-indigo-300 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-cyan-400">
                            <option value="AND">AND</option>
                            <option value="OR">OR</option>
                            <option value="NOT">NOT</option>
                        </select>
                        <button type="button" class="remove-row btn-secondary text-white px-4 py-2 rounded-lg font-semibold">Remove</button>
                    </div>`;
            }
            updateSQLPreview();
            document.getElementById("query-form").dispatchEvent(new Event("submit"));
        }
    });

    // SQL Preview
    function updateSQLPreview() {
        const startDate = document.getElementById("startDate").value;
        const endDate = document.getElementById("endDate").value;
        const state = document.getElementById("state").value;
        const activityType = document.getElementById("activityType").value;
        const eventCategory = document.getElementById("eventCategory").value;
        const filterOperator = document.getElementById("filterOperator").value;
        const queryRows = document.querySelectorAll(".query-row");
        let sql = `SELECT * FROM activity WHERE event_date BETWEEN '${startDate || "YYYY-MM-DD"}' AND '${endDate || "YYYY-MM-DD"}'`;
        const filterConditions = [];
        if (state) filterConditions.push(`state = '${state}'`);
        if (activityType) filterConditions.push(`activity_type = '${activityType}'`);
        if (eventCategory) filterConditions.push(`event_category = '${eventCategory}'`);
        if (filterConditions.length > 0) {
            sql += ` ${filterOperator} (${filterConditions.join(` ${filterOperator} `)})`;
        }
        queryRows.forEach((row, index) => {
            const field = row.querySelector(".field").value;
            const operator = row.querySelector(".operator").value;
            const value = row.querySelector(".value").value;
            const logical = row.querySelector(".logical").value;
            if (value) {
                sql += index === 0 && filterConditions.length === 0 ? ' AND ' : ` ${logical} `;
                sql += `${field} ${operator} '${value}'`;
            }
        });
        sql += ";";
        document.getElementById("sql-preview").textContent = sql;
    }
    document.getElementById("query-form").addEventListener("input", updateSQLPreview);

    // Render table with pagination
    function renderTable() {
        const tbody = document.getElementById("activity-table-body");
        tbody.innerHTML = "";
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const paginatedActivities = activities.slice(start, end);

        if (paginatedActivities.length === 0) {
            tbody.innerHTML = `<tr><td colspan="12" class="p-3 text-center font-semibold">No activities found</td></tr>`;
        } else {
            paginatedActivities.forEach(activity => {
                const tr = document.createElement("tr");
                tr.className = "hover:bg-white/20 dark:hover:bg-gray-600/20 transition";
                tr.innerHTML = `
                    <td class="p-3 border border-yellow-300">${activity.id || ""}</td>
                    <td class="p-3 border border-yellow-300">${activity.state || ""}</td>
                    <td class="p-3 border border-yellow-300">${activity.stationName || ""}</td>
                    <td class="p-3 border border-yellow-300">${activity.activityType || ""}</td>
                    <td class="p-3 border border-yellow-300">${activity.eventCategory || ""}</td>
                    <td class="p-3 border border-yellow-300">${activity.participantCategory || ""}</td>
                    <td class="p-3 border border-yellow-300">${activity.eventDescription || ""}</td>
                    <td class="p-3 border border-yellow-300">${activity.schoolOrCollegeOrPanchayatName || ""}</td>
                    <td class="p-3 border border-yellow-300">${activity.eventLocation || ""}</td>
                    <td class="p-3 border border-yellow-300">${activity.eventDate || ""}</td>
                    <td class="p-3 border border-yellow-300">${activity.numberOfParticipants || 0}</td>
                    <td class="p-3 border border-yellow-300">${activity.remarks || ""}</td>`;
                tbody.appendChild(tr);
            });
        }
        renderPagination();
        updatePerformanceMetrics();
    }

    // Render pagination
    function renderPagination() {
        const pagination = document.getElementById("pagination");
        pagination.innerHTML = "";
        const pageCount = Math.ceil(activities.length / rowsPerPage);
        for (let i = 1; i <= pageCount; i++) {
            const button = document.createElement("button");
            button.textContent = i;
            button.className = `btn-primary text-white px-4 py-2 rounded-lg font-semibold ${i === currentPage ? "opacity-50 cursor-not-allowed" : ""}`;
            button.disabled = i === currentPage;
            button.onclick = () => {
                currentPage = i;
                renderTable();
            };
            pagination.appendChild(button);
        }
    }

    // Update performance metrics
    function updatePerformanceMetrics() {
        const metricsDiv = document.getElementById("performanceMetrics");
        const executionTime = Math.random() * 1000; // Simulated execution time
        metricsDiv.textContent = `Query executed in ${executionTime.toFixed(2)}ms | ${activities.length} results found`;
    }

    // Table sorting
    document.querySelectorAll(".table-header").forEach(header => {
        header.addEventListener("click", () => {
            const field = header.dataset.sort;
            if (sortField === field) {
                sortDir = sortDir === "asc" ? "desc" : "asc";
            } else {
                sortField = field;
                sortDir = "asc";
            }
            document.querySelectorAll(".table-header").forEach(h => {
                h.querySelector(".sort-icon").className = "sort-icon";
            });
            header.querySelector(".sort-icon").className = `sort-icon sort-${sortDir}`;
            sortTable();
            renderTable();
        });
    });

    function sortTable() {
        activities.sort((a, b) => {
            const keys = {
                id: 'id',
                state: 'state',
                stationName: 'stationName',
                activityType: 'activityType',
                eventCategory: 'eventCategory',
                participantCategory: 'participantCategory',
                eventDescription: 'eventDescription',
                schoolOrCollegeOrPanchayatName: 'schoolOrCollegeOrPanchayatName',
                eventLocation: 'eventLocation',
                eventDate: 'eventDate',
                numberOfParticipants: 'numberOfParticipants',
                remarks: 'remarks'
            };
            let aValue = a[keys[sortField]] || "";
            let bValue = b[keys[sortField]] || "";
            if (sortField === "numberOfParticipants") {
                aValue = Number(aValue) || 0;
                bValue = Number(bValue) || 0;
                return sortDir === "asc" ? aValue - bValue : bValue - aValue;
            } else if (sortField === "eventDate") {
                return sortDir === "asc" ? new Date(aValue) - new Date(bValue) : new Date(bValue) - new Date(aValue);
            } else {
                return sortDir === "asc" ? String(aValue).localeCompare(String(bValue)) : String(bValue).localeCompare(String(aValue));
            }
        });
    }

    // Form submission
    document.getElementById("query-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!validateDates()) return;
        const startTime = performance.now();
        const formData = new FormData(e.target);
        const queryRows = document.querySelectorAll(".query-row");
        const conditions = Array.from(queryRows).map(row => ({
            field: row.querySelector(".field").value,
            operator: row.querySelector(".operator").value,
            value: row.querySelector(".value").value,
            logical: row.querySelector(".logical").value
        })).filter(c => c.value);
        formData.append("conditions", JSON.stringify(conditions));
        try {
            const response = await fetch("/api/dateRangeQuery", {
                method: "POST",
                body: formData
            });
            const data = await response.json();
            if (data.errorMessage) {
                alert(data.errorMessage);
                document.getElementById("activity-table-body").innerHTML = `<tr><td colspan="12" class="p-3 text-center font-semibold">No activities found</td></tr>`;
                activities = [];
                renderTable();
                return;
            }
            activities = data.activities;
            currentPage = 1;
            renderTable();
            // Save to query history
            queryHistory.unshift({
                startDate: formData.get("startDate"),
                endDate: formData.get("endDate"),
                filters: {
                    state: formData.get("state"),
                    activityType: formData.get("activityType"),
                    eventCategory: formData.get("eventCategory"),
                    filterOperator: formData.get("filterOperator")
                },
                conditions: conditions
            });
            if (queryHistory.length > 10) queryHistory.pop();
            localStorage.setItem("queryHistory", JSON.stringify(queryHistory));
            updateQueryHistory();
        } catch (error) {
            console.error("Error fetching activities:", error);
            alert("An error occurred while fetching activities.");
            activities = [];
            renderTable();
        }
    });

    // Initial render
    renderTable();
</script>
</body>
</html>