<!DOCTYPE html>
<html lang="en" th:lang="${#locale.language}" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Manage and track activities with real-time updates">
    <title>Activity Management System</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.9/dist/flatpickr.min.css" rel="stylesheet">
    <link href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.9/dist/flatpickr.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        :root {
            --bg-color: #F5F5DC; /* Soft beige (Earthy tone) */
            --text-color: #4A3728; /* Rich brown (Earthy tone) */
            --table-bg: #FFF8E1; /* Warm cream (Earthy tone) */
            --table-border: #D4A373; /* Sandy brown (Earthy tone) */
            --btn-primary-bg: #FF6F61; /* Vibrant coral (Powerful color) */
            --active-row-bg: #FFE4E1; /* Soft pink (Pastel) */
            --active-field-border: #40C4FF; /* Bright sky blue (Powerful color) */
            --search-bg: #E8F5E9; /* Pale green (Pastel) */
            --search-border: #A5D6A7; /* Soft green (Earthy tone) */
            --search-focus: #26A69A; /* Teal (Powerful color) */
        }
        [data-theme="dark"] {
            --bg-color: #2E2E2E; /* Dark slate (Earthy dark tone) */
            --text-color: #E0E0E0; /* Light grey (Pastel contrast) */
            --table-bg: #3C2F2F; /* Deep brown (Earthy dark tone) */
            --table-border: #6D8299; /* Muted blue-grey (Earthy tone) */
            --btn-primary-bg: #FF8A65; /* Bright coral (Powerful color) */
            --active-row-bg: #4A3728; /* Dark brown (Earthy tone) */
            --active-field-border: #4FC3F7; /* Lighter sky blue (Powerful color) */
            --search-bg: #37474F; /* Dark slate (Earthy dark tone) */
            --search-border: #78909C; /* Muted blue (Earthy tone) */
            --search-focus: #4DD0E1; /* Cyan (Powerful color) */
        }
        .highlight {
            background-color: #FFF59D !important; /* Bright pastel yellow */
        }
        body {
            background: linear-gradient(135deg, #F5F5DC, #E8F5E9); /* Gradient of beige to pale green */
            color: var(--text-color);
            font-family: 'Segoe UI', Arial, sans-serif;
            transition: all 0.3s ease;
            margin: 0;
        }
        .header {
            background: linear-gradient(90deg, #FF6F61, #FFCA28); /* Coral to bright yellow */
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            border-bottom: 4px solid #26A69A; /* Teal accent */
        }
        .navbar {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: linear-gradient(90deg, #FFE0B2, #B2DFDB); /* Pastel orange to mint */
            padding: 15px 0;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            border-radius: 0 0 10px 10px;
        }
        .dropdown {
            position: relative;
            display: inline-block;
            margin: 0 10px;
        }
        .dropdown-toggle {
            background: var(--btn-primary-bg);
            color: white;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            font-size: 16px;
            border-radius: 8px;
            transition: transform 0.2s ease, background 0.3s ease;
        }
        .dropdown-toggle:hover {
            transform: scale(1.05);
            background: #FFCA28; /* Bright yellow */
        }
        .dropdown-menu {
            min-width: 180px;
            background: #FFF8E1; /* Warm cream */
            border: 2px solid #FF6F61; /* Coral border */
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .dropdown-menu .dropdown-item {
            color: var(--text-color);
            padding: 10px;
            font-weight: 500;
        }
        .dropdown-menu .dropdown-item:hover {
            background: #FFE4E1; /* Soft pink */
            color: #FF6F61; /* Coral text */
        }
        .container {
            padding: 30px;
            background: var(--bg-color);
            border-radius: 12px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }
        .table-container {
            background: var(--table-bg);
            border-radius: 12px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            margin-bottom: 2.5rem;
        }
        .table {
            background: var(--table-bg);
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
        }
        .table thead th {
            background: linear-gradient(45deg, #FF6F61, #FFCA28); /* Coral to yellow gradient */
            color: white;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 1rem;
            padding: 1.2rem;
            border: none;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .table th.sort-asc::after {
            content: ' ↑';
            color: #FFF59D; /* Bright pastel yellow */
        }
        .table th.sort-desc::after {
            content: ' ↓';
            color: #FFF59D;
        }
        .table tbody tr {
            background: var(--table-bg);
            border-bottom: 2px solid var(--table-border);
            transition: all 0.3s ease;
        }
        .table tbody tr:hover {
            background: var(--active-row-bg);
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }
        .table tbody tr.active-row {
            background: var(--active-row-bg);
        }
        .table td {
            padding: 1.2rem;
            vertical-align: middle;
            border: none;
            font-size: 1rem;
            color: var(--text-color);
        }
        .table td.editable:hover {
            background: #FFE4E1; /* Soft pink */
            cursor: pointer;
            border-left: 3px solid var(--active-field-border);
        }
        .table td.editing {
            background: #E8F5E9; /* Pale green */
            position: relative;
        }
        .table td .form-control {
            font-size: 1rem;
            border-radius: 8px;
            border: 2px solid var(--search-border);
            padding: 8px;
        }
        .table td .form-control:focus {
            border-color: var(--search-focus);
            box-shadow: 0 0 8px rgba(38, 166, 154, 0.4); /* Teal glow */
        }
        .text-highlight {
            background-color: #FFF59D !important; /* Bright pastel yellow */
        }
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }
        .editable:hover {
            background-color: #FFE4E1; /* Soft pink */
            cursor: pointer;
        }
        .editing .edit-buttons {
            display: inline-flex;
            gap: 10px;
        }
        .edit-buttons button {
            background: #FFCA28; /* Bright yellow */
            color: #4A3728; /* Rich brown */
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 600;
        }
        .edit-buttons button:hover {
            background: #FF6F61; /* Coral */
            color: white;
        }
        .error-message {
            color: #EF5350; /* Bright red */
            font-size: 0.85em;
            display: none;
        }
        .editable.is-invalid .error-message {
            display: block;
        }
        .spinner {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 6px solid #E8F5E9; /* Pale green */
            border-top: 6px solid var(--btn-primary-bg);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        .session-warning {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            background: #FFCA28; /* Bright yellow */
            color: #4A3728; /* Rich brown */
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .session-warning button {
            background: #FF6F61; /* Coral */
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
        }
        .chatbot-feedback {
            background: #E8F5E9; /* Pale green */
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 0.95em;
            max-height: 120px;
            overflow-y: auto;
            border: 2px solid #A5D6A7; /* Soft green */
        }
        .mic-btn {
            margin-left: 12px;
            background: var(--btn-primary-bg);
            color: white;
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 50%;
            transition: transform 0.2s ease;
        }
        .mic-btn:hover {
            transform: scale(1.1);
        }
        .mic-btn.recording {
            background: #EF5350; /* Bright red */
        }
        .confirmation-modal {
            background: rgba(0, 0, 0, 0.6);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .confirmation-modal-content {
            background: var(--bg-color);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 0 12px rgba(0, 0, 0, 0.3);
            max-width: 550px;
            width: 95%;
            border: 3px solid #FF6F61; /* Coral */
        }
        .confirmation-modal-content button {
            background: #FFCA28; /* Bright yellow */
            color: #4A3728; /* Rich brown */
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
        }
        .confirmation-modal-content button:hover {
            background: #FF6F61; /* Coral */
            color: white;
        }
        .search-container {
            margin-bottom: 15px;
            max-width: 600px;
            background: var(--search-bg);
            padding: 10px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .search-container input {
            border-radius: 8px 0 0 8px;
            border: 2px solid var(--search-border);
            padding: 12px 18px;
            font-size: 16px;
        }
        .search-container .input-group-text,
        .search-container .keyboard-btn {
            border-radius: 0 8px 8px 0;
            background: var(--btn-primary-bg);
            color: white;
            border: 2px solid var(--search-border);
            border-left: none;
            padding: 12px 18px;
            transition: transform 0.2s ease;
        }
        .search-container .input-group-text:hover,
        .search-container .keyboard-btn:hover {
            background: #FFCA28; /* Bright yellow */
            transform: scale(1.05);
        }
        .search-container .form-control:focus {
            border-color: var(--search-focus);
            box-shadow: 0 0 8px rgba(38, 166, 154, 0.4);
        }
        @media (max-width: 768px) {
            .table {
                display: block;
                overflow-x: auto;
            }
            .table thead {
                display: none;
            }
            .table tbody tr {
                display: block;
                margin-bottom: 2rem;
                border: 2px solid var(--table-border);
                border-radius: 12px;
                box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            }
            .table tbody td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 1rem 1.2rem;
                border-bottom: 1px solid var(--table-border);
            }
            .table tbody td:before {
                content: attr(data-label);
                font-weight: 600;
                color: var(--btn-primary-bg);
                flex: 1;
                margin-right: 1.2rem;
            }
            .table tbody td:last-child {
                border-bottom: none;
            }
            .actions {
                flex-direction: column;
                align-items: center;
                gap: 1rem;
            }
            .edit-buttons {
                position: static;
                transform: none;
                justify-content: center;
                margin-top: 0.75rem;
            }
            .navbar .btn {
                margin: 8px;
            }
            .search-container {
                max-width: 100%;
                padding: 0 20px;
            }
        }
        .download-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #B0BEC5; /* Muted grey */
        }
        .pagination-section {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 25px;
            background: #E8F5E9; /* Pale green */
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .page-size-select {
            width: 120px;
            border: 2px solid #A5D6A7; /* Soft green */
            border-radius: 8px;
            padding: 8px;
        }
        .upload-btn {
            background: #26A69A; /* Teal */
            color: white;
            margin-left: 8px;
            border-radius: 8px;
            padding: 8px 16px;
            transition: transform 0.2s ease;
        }
        .upload-btn:hover {
            background: #00897B; /* Darker teal */
            transform: scale(1.05);
        }
        #dashboardSection {
            transform: scale(1);
            transform-origin: top left;
            width: 100%;
            transition: transform 0.2s ease;
            background: #FFF8E1; /* Warm cream */
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        .dashboard-container {
            overflow: auto;
        }
        .modal-column-select {
            background: rgba(0, 0, 0, 0.6);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .modal-column-select-content {
            background: var(--bg-color);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 0 12px rgba(0, 0, 0, 0.3);
            max-width: 450px;
            width: 95%;
            border: 3px solid #FF6F61; /* Coral */
        }
        .modal-column-select-content label {
            display: block;
            margin: 12px 0;
            color: var(--text-color);
            font-weight: 500;
        }
        .hidden-column {
            display: none !important;
        }
        .virtual-keyboard {
            background: linear-gradient(180deg, #FFE0B2, #B2DFDB); /* Pastel orange to mint */
            padding: 12px;
            margin: 12px 0;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            border: 2px solid #FF6F61; /* Coral */
            border-radius: 12px;
            display: none;
        }
        .virtual-keyboard .keyboard-row {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
            margin-bottom: 6px;
        }
        .virtual-keyboard button {
            flex: 0 0 5.5%;
            min-width: 45px;
            padding: 10px;
            font-size: 1rem;
            border-radius: 8px;
            background: #FFF8E1; /* Warm cream */
            border: 1px solid #A5D6A7; /* Soft green */
            transition: background 0.2s, transform 0.1s;
        }
        .virtual-keyboard button:hover {
            background: #FF6F61; /* Coral */
            color: white;
            transform: scale(1.1);
        }
        .virtual-keyboard .special-key {
            flex: 0 0 12%;
        }
        .virtual-keyboard .wide-key {
            flex: 0 0 18%;
        }
        .virtual-keyboard .extra-wide-key {
            flex: 0 0 25%;
        }
        th {
            background: linear-gradient(45deg, #FF6F61, #FFCA28); /* Coral to yellow */
            position: sticky;
            top: 0;
            z-index: 10;
        }
        th:first-child, td:first-child {
            position: sticky;
            left: 0;
            background: #FFF8E1; /* Warm cream */
            z-index: 5;
        }
        th.draggable {
            cursor: pointer;
        }
        th.draggable.selected {
            background: #D4A373; /* Sandy brown */
        }
        .actions {
            margin-bottom: 25px;
        }
        .quick-actions button {
            background: #FF6F61; /* Coral */
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s ease;
        }
        .quick-actions button:hover {
            background: #FFCA28; /* Bright yellow */
            transform: scale(1.05);
        }
        .quick-actions .dropdown {
            display: none;
            position: absolute;
            background: #FFF8E1; /* Warm cream */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            min-width: 220px;
            z-index: 1;
            border: 2px solid #FF6F61; /* Coral */
        }
        .quick-actions:hover .dropdown {
            display: block;
        }
        .quick-actions .dropdown a {
            display: block;
            padding: 12px;
            color: var(--text-color);
            text-decoration: none;
            font-weight: 500;
        }
        .quick-actions .dropdown a:hover {
            background: #FFE4E1; /* Soft pink */
            color: #FF6F61; /* Coral */
        }
        .columns-toggle button {
            background: #FF6F61; /* Coral */
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s ease;
        }
        .columns-toggle button:hover {
            background: #FFCA28; /* Bright yellow */
            transform: scale(1.05);
        }
        .columns-toggle .dropdown {
            display: none;
            position: absolute;
            background: #FFF8E1; /* Warm cream */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            min-width: 160px;
            max-height: 220px;
            overflow-y: auto;
            top: 48px;
            z-index: 1;
            border: 2px solid #FF6F61; /* Coral */
        }
        .columns-toggle:hover .dropdown {
            display: block;
        }
        .columns-toggle .dropdown label {
            display: block;
            padding: 8px 12px;
            color: var(--text-color);
            font-size: 15px;
            font-weight: 500;
        }
        .columns-toggle .dropdown label:hover {
            background: #FFE4E1; /* Soft pink */
            color: #FF6F61; /* Coral */
        }
        .sort-columns button {
            background: #FF6F61; /* Coral */
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s ease;
            margin-left:20px;
        }
        .sort-columns button:hover {
            background: #FFCA28; /* Bright yellow */
            transform: scale(1.05);
        }
        .sort-columns .dropdown {
            display: none;
            position: absolute;
            background: #FFF8E1; /* Warm cream */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            min-width: 160px;
            max-height: 220px;
            overflow-y: auto;
            top: 48px;
            z-index: 1;
            border: 2px solid #FF6F61; /* Coral */
        }
        .sort-columns:hover .dropdown {
            display: block;
        }
        .sort-columns .dropdown div {
            padding: 8px 12px;
            font-size: 15px;
            color: var(--text-color);
        }
        .sort-columns .dropdown div:hover {
            background: #FFE4E1; /* Soft pink */
            color: #FF6F61; /* Coral */
        }
        .sort-columns .dropdown button {
            background: #26A69A; /* Teal */
            color: white;
            padding: 6px 12px;
            margin: 3px 6px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
        }
        .sort-columns .dropdown button.asc:hover,
        .sort-columns .dropdown button.desc:hover {
            background: #00897B; /* Darker teal */
        }
         .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 50;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            border-radius: 0.5rem;
            max-width: 500px;
            width: 90%;
            max-height: 50vh;
            overflow-y: auto;
            padding: 2rem;
            position: relative;
        }
        .modal-content img {
            max-width: 200%;
            height: auto;
            border-radius: 0.25rem;
            margin: 1rem 0;
        }
        .close-button {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            font-size: 1.5rem;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="spinner" id="spinner"></div>
    <div class="alert alert-warning session-warning" role="alert">
        Your session will expire in 1 minute. <button id="extendSession" class="btn btn-sm btn-primary"><i class="fas fa-clock"></i> Extend</button>
    </div>

    <div class="header">
        <h1 style="font-size: 48px; color: white; font-weight: bold; text-shadow: 3px 3px 6px rgba(0,0,0,0.3);"><i class="fas fa-tasks"></i> Activity Management System</h1>
    </div>
   

    <!-- User Guide Modal -->
    <div id="guideModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-button" onclick="closeGuideModal()">&times;</span>
            <h2 class="text-2xl font-bold mb-4">User Guide: Activity Management System</h2>
            <p class="mb-4">Welcome to the Activity Management System! This guide will walk you through the key features of the web application to help you manage activities effectively.</p>

            <h3 class="text-xl font-semibold mb-2">1. Dashboard</h3>
            <p>The Dashboard provides a quick overview of your activity data, including metrics like Total Activities, Total Participants, Unique States, and Average Participants. It also includes placeholders for visualizations like Events by Date and Category Distribution. Use the Zoom In/Out buttons to adjust chart views.</p>
            <img src="images/Dashboard.jpg" alt="Dashboard showing key metrics and visualizations" class="mb-4">
            <p><strong>How to Use:</strong> Check the Dashboard to monitor your activity metrics. Add activities to see updated data.</p>

            <h3 class="text-xl font-semibold mb-2">2. Quick Actions</h3>
            <p>The Quick Actions dropdown offers shortcuts for tasks like adding activities, exporting data, switching themes, and filtering activities by state, category, or date range.</p>
            <img src="images/QuickActions.jpg" alt="Quick Actions dropdown menu" class="mb-4">
            <p><strong>How to Use:</strong> Select an option from the Quick Actions dropdown to perform tasks efficiently.</p>

            <h3 class="text-xl font-semibold mb-2">3. Activities List</h3>
            <p>The Activities List displays all activities in a table with columns like State, Activity Type, Event Date, and Number of Participants. Features include sorting, pagination, and operations like Edit, Download, and Delete All Images.</p>
            <img src="images/Activities.jpg" alt="Activities List table with sorting and pagination" class="mb-4">
            <p><strong>How to Use:</strong> Browse, sort, or filter activities. Use checkboxes for bulk actions or click Edit to modify an activity.</p>

            <h3 class="text-xl font-semibold mb-2">4. Add New Activity</h3>
            <p>The Add New Activity form lets you input details for a new activity, with validation for fields like Event Date (YYYY-MM-DD) and Number of Participants (1–1000).</p>
            <img src="images/Add-Activity.jpg" alt="Add New Activity form" class="mb-4">
            <p><strong>How to Use:</strong> Fill out the form and click Save to add an activity.</p>

            <h3 class="text-xl font-semibold mb-2">5. Bulk Edit</h3>
            <p>Bulk Edit allows you to modify multiple activities at once. Select activities, update fields, or use Smart Actions like setting the Event Date to today or incrementing participants.</p>
            <img src="images/bulk-edit.jpg" alt="Bulk Edit modal" class="mb-4">
            <p><strong>How to Use:</strong> Select activities, open Bulk Edit from Quick Actions, update fields, and save changes.</p>

            <h3 class="text-xl font-semibold mb-2">6. Calculate Section</h3>
            <p>The Calculate section lets you perform aggregate calculations (e.g., COUNT, SUM, AVG) on columns like Number of Participants, with options to group by or filter data.</p>
            <img src="images/calculate-section.jpg" alt="Calculate section with aggregate functions" class="mb-4">
            <p><strong>How to Use:</strong> Select a function, column, and conditions, then click Calculate to view results.</p>

            <h3 class="text-xl font-semibold mb-2">7. Virtual Keyboard</h3>
            <p>The Virtual Keyboard mimics a physical keyboard for input on touch-screen devices or accessibility needs.</p>
            <img src="images/Virtual-keyword.jpg" alt="Virtual Keyboard" class="mb-4">
            <p><strong>How to Use:</strong> Click virtual keys to input text in forms.</p>

            <h3 class="text-xl font-semibold mb-2">8. Session Management</h3>
            <p>A session expiration warning appears when your session is about to expire. Click Extend to stay logged in.</p>
            <img src="images/session-warning.jpg" alt="Session expiration warning" class="mb-4">
            <p><strong>How to Use:</strong> Monitor the warning and extend your session as needed.</p>

            <h3 class="text-xl font-semibold mb-2">9. Additional Features</h3>
            <p>Features like Export to CSV, Switch Theme, AI Suggestions, and Analytics enhance data management and user experience.</p>
            <img src="images/export-csv.jpg" alt="Export to CSV feature" class="mb-4">
            <p><strong>How to Use:</strong> Access these features via Quick Actions for advanced functionality.</p>

            <h3 class="text-xl font-semibold mb-2">10. Getting Started</h3>
            <p>Start by adding an activity, exploring the Dashboard, managing the Activities List, performing bulk edits, running calculations, and exporting data for analysis.</p>
            <p><strong>Tips:</strong> Ensure required fields are filled, use Smart Actions for efficiency, and export data regularly for backups.</p>
        </div>
    </div>
    <div class="dashboard-container">
        <div id="dashboardSection" class="mb-8 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold"><i class="fas fa-chart-line"></i> Dashboard</h2>
                <div class="flex items-center gap-3">
                    <button id="zoomIn" class="bg-blue-500 text-white px-3 py-1 rounded text-sm"><i class="fas fa-search-plus"></i> Zoom In</button>
                    <button id="zoomOut" class="bg-blue-500 text-white px-3 py-1 rounded text-sm"><i class="fas fa-search-minus"></i> Zoom Out</button>
                    <button id="closeDashboard" class="text-gray-600 text-2xl font-bold">×</button>
                </div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-white p-4 rounded-lg shadow">
                    <h3 class="text-lg font-medium"><i class="fas fa-list"></i> Total Activities</h3>
                    <p id="totalActivities" class="text-2xl font-bold">0</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <h3 class="text-lg font-medium"><i class="fas fa-users"></i> Total Participants</h3>
                    <p id="totalParticipants" class="text-2xl font-bold">0</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <h3 class="text-lg font-medium"><i class="fas fa-map-marker-alt"></i> Unique States</h3>
                    <p id="uniqueStates" class="text-2xl font-bold">0</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <h3 class="text-lg font-medium"><i class="fas fa-calculator"></i> Avg. Participants</h3>
                    <p id="averageParticipants" class="text-2xl font-bold" th:text="${dashboardStats?.avgParticipants != null ? #numbers.formatInteger(dashboardStats.avgParticipants, 0) : '0'}"></p>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                <div class="bg-white p-4 rounded-lg shadow">
                    <h3 class="text-lg font-medium mb-3"><i class="fas fa-calendar-alt"></i> Events by Date</h3>
                    <canvas id="eventsByDateChart" style="max-height: 220px;"></canvas>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <h3 class="text-lg font-medium mb-3"><i class="fas fa-pie-chart"></i> Category Distribution</h3>
                    <canvas id="categoryChart" style="max-height: 220px;"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="container">
        <nav class="navbar">
            <div class="mb-4 d-flex flex-wrap justify-content-center">
                <a href="/add" class="btn btn-primary mr-2" style="background-color: var(--btn-primary-bg); border-radius: 12px;"><i class="fas fa-plus-circle"></i> Add New Activity</a>
                <div class="dropdown">
                    <button class="btn btn-primary dropdown-toggle" type="button" id="quickActionsDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="background-color: var(--btn-primary-bg);border-radius:12px;">
                        <i class="fas fa-bolt"></i> Quick Actions
                    </button>
                    <div class="dropdown-menu" aria-labelledby="quickActionsDropdown">
                        <button class="dropdown-item" id="bulkEdit" data-toggle="modal" data-target="#bulkEditModal"><i class="fas fa-edit"></i> Bulk Edit</button>
                        <button class="dropdown-item" id="bulkDelete"><i class="fas fa-trash-alt"></i> Remove Selected</button>
                        <a class="dropdown-item" href="#" id="exportCsv"><i class="fas fa-file-csv"></i> Export to CSV</a>
                        <button class="dropdown-item" id="toggleDarkMode"><i class="fas fa-moon"></i> Switch Theme</button>
                        <button class="dropdown-item" id="viewAiSuggestions" data-toggle="modal" data-target="#aiSuggestionsModal"><i class="fas fa-brain"></i> View AI Suggestions</button>
                        <button class="dropdown-item" id="viewAnalytics"><i class="fas fa-chart-bar"></i> View Analytics</button>
                        <a class="dropdown-item" href="/stateCategoryQuery"><i class="fas fa-filter"></i> Filter by State & Category</a>
                        <a class="dropdown-item" href="/dateRangeQuery"><i class="fas fa-calendar-day"></i> Filter by Date Range</a>
                        <a class="dropdown-item" href="/confirmExit"><i class="fas fa-sign-out-alt"></i> Logout</a>
                    </div>
                </div>
                <div class="columns-toggle">
                    <button><i class="fas fa-columns"></i> Columns...</button>
                    <div class="dropdown">
                        <label><input type="checkbox" class="column-toggle-checkbox" data-column="0" checked> Select</label>
                        <label><input type="checkbox" class="column-toggle-checkbox" data-column="1" checked> ID</label>
                        <label><input type="checkbox" class="column-toggle-checkbox" data-column="2" checked> State</label>
                        <label><input type="checkbox" class="column-toggle-checkbox" data-column="3" checked> Station Name</label>
                        <label><input type="checkbox" class="column-toggle-checkbox" data-column="4" checked> Activity Type</label>
                        <label><input type="checkbox" class="column-toggle-checkbox" data-column="5" checked> Event Category</label>
                        <label><input type="checkbox" class="column-toggle-checkbox" data-column="6" checked> Participant Category</label>
                        <label><input type="checkbox" class="column-toggle-checkbox" data-column="7" checked> Event Description</label>
                        <label><input type="checkbox" class="column-toggle-checkbox" data-column="8" checked> School/College/Panchayat Name</label>
                        <label><input type="checkbox" class="column-toggle-checkbox" data-column="9" checked> Event Location</label>
                        <label><input type="checkbox" class="column-toggle-checkbox" data-column="10" checked> Event Date</label>
                        <label><input type="checkbox" class="column-toggle-checkbox" data-column="11" checked> Number of Participants</label>
                        <label><input type="checkbox" class="column-toggle-checkbox" data-column="12" checked> Remarks</label>
                        <label><input type="checkbox" class="column-toggle-checkbox" data-column="13" checked> Operations</label>
                    </div>
                </div>
                <div class="sort-columns">
                    <button><i class="fas fa-sort"></i> Sort Columns</button>
                    <div class="dropdown">
                        <div>
                            <span>Select</span>
                            <button class="asc" data-column="0">Asc</button>
                            <button class="desc" data-column="0">Desc</button>
                        </div>
                        <div>
                            <span>ID</span>
                            <button class="asc" data-column="1">Asc</button>
                            <button class="desc" data-column="1">Desc</button>
                        </div>
                        <div>
                            <span>State</span>
                            <button class="asc" data-column="2">Asc</button>
                            <button class="desc" data-column="2">Desc</button>
                        </div>
                        <div>
                            <span>Station Name</span>
                            <button class="asc" data-column="3">Asc</button>
                            <button class="desc" data-column="3">Desc</button>
                        </div>
                        <div>
                            <span>Activity Type</span>
                            <button class="asc" data-column="4">Asc</button>
                            <button class="desc" data-column="4">Desc</button>
                        </div>
                        <div>
                            <span>Event Category</span>
                            <button class="asc" data-column="5">Asc</button>
                            <button class="desc" data-column="5">Desc</button>
                        </div>
                        <div>
                            <span>Participant Category</span>
                            <button class="asc" data-column="6">Asc</button>
                            <button class="desc" data-column="6">Desc</button>
                        </div>
                        <div>
                            <span>Event Description</span>
                            <button class="asc" data-column="7">Asc</button>
                            <button class="desc" data-column="7">Desc</button>
                        </div>
                        <div>
                            <span>School/College/Panchayat Name</span>
                            <button class="asc" data-column="8">Asc</button>
                            <button class="desc" data-column="8">Desc</button>
                        </div>
                        <div>
                            <span>Event Location</span>
                            <button class="asc" data-column="9">Asc</button>
                            <button class="desc" data-column="9">Desc</button>
                        </div>
                        <div>
                            <span>Event Date</span>
                            <button class="asc" data-column="10">Asc</button>
                            <button class="desc" data-column="10">Desc</button>
                        </div>
                        <div>
                            <span>Number of Participants</span>
                            <button class="asc" data-column="11">Asc</button>
                            <button class="desc" data-column="11">Desc</button>
                        </div>
                        <div>
                            <span>Remarks</span>
                            <button class="asc" data-column="12">Asc</button>
                            <button class="desc" data-column="12">Desc</button>
                        </div>
                        <div>
                            <span>Operations</span>
                            <button class="asc" data-column="13">Asc</button>
                            <button class="desc" data-column="13">Desc</button>
                        </div>
                    </div>
                </div>
                  <button id="userGuideButton" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700" style=margin-left:20px;>User Guide</button>
            </div>
        </nav>
        <div class="search-container">
            <div class="input-group">
                <input type="text" class="form-control" id="searchBar" placeholder="Enter command (e.g., 'insert a record', 'retrieve record with id 123')" aria-label="Search commands">
                <div class="input-group-append">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                </div>
            </div>
        </div>
        <div class="search-container mt-3">
            <div class="input-group">
                <input type="text" class="form-control" id="searchInput" placeholder="Search activities..." onkeyup="searchTable()" aria-label="Search activities">
                <div class="input-group-append">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <button class="btn btn-primary keyboard-btn" type="button" onclick="toggleKeyboard()"><i class="fas fa-keyboard"></i></button>
                </div>
            </div>
        </div>
        <div class="modal fade" id="bulkEditModal" tabindex="-1" role="dialog" aria-labelledby="bulkEditModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="bulkEditModalLabel"><i class="fas fa-edit"></i> Bulk Edit Activities (<span id="selectedCount">0</span> selected)</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group nlp-input">
                            <input type="text" class="form-control" id="nlpCommand" placeholder="e.g., state Karnataka or show images">
                            <button class="mic-btn" id="voiceInputBtn" aria-label="Start voice input"><i class="fas fa-microphone"></i></button>
                        </div>
                        <div class="chatbot-feedback" id="chatbotFeedback">Enter a command (e.g., "state Karnataka" or "show images") or use voice input.</div>
                        <div class="form-group">
                            <label for="smartActions"><i class="fas fa-cogs"></i> Smart Actions</label>
                            <select id="smartActions" class="form-control">
                                <option value="">Select a smart action</option>
                                <option value="setToday">Set Event Date to Today</option>
                                <option value="incrementParticipants">Increment Participants by 10</option>
                                <option value="clearRemarks">Clear Remarks</option>
                            </select>
                        </div>
                        <form id="bulkEditForm">
                            <div class="form-group">
                                <label for="bulkState"><i class="fas fa-map"></i> State</label>
                                <input type="text" class="form-control" id="bulkState" name="state">
                                <div class="invalid-feedback">State is required if provided</div>
                            </div>
                            <div class="form-group">
                                <label for="bulkStationName"><i class="fas fa-building"></i> Station Name</label>
                                <input type="text" class="form-control" id="bulkStationName" name="stationName">
                                <div class="invalid-feedback">Station Name is required if provided</div>
                            </div>
                            <div class="form-group">
                                <label for="bulkActivityType"><i class="fas fa-tasks"></i> Activity Type</label>
                                <input type="text" class="form-control" id="bulkActivityType" name="activityType">
                                <div class="invalid-feedback">Activity Type is required if provided</div>
                            </div>
                            <div class="form-group">
                                <label for="bulkEventCategory"><i class="fas fa-tag"></i> Event Category</label>
                                <input type="text" class="form-control" id="bulkEventCategory" name="eventCategory">
                                <div class="invalid-feedback">Event Category is required if provided</div>
                            </div>
                            <div class="form-group">
                                <label for="bulkParticipantCategory"><i class="fas fa-users"></i> Participant Category</label>
                                <input type="text" class="form-control" id="bulkParticipantCategory" name="participantCategory">
                                <div class="invalid-feedback">Participant Category is required if provided</div>
                            </div>
                            <div class="form-group">
                                <label for="bulkEventDescription"><i class="fas fa-comment"></i> Event Description</label>
                                <textarea class="form-control" id="bulkEventDescription" name="eventDescription"></textarea>
                                <div class="invalid-feedback">Event Description is required if provided</div>
                            </div>
                            <div class="form-group">
                                <label for="bulkSchoolOrCollegeOrPanchayatName"><i class="fas fa-school"></i> School/College/Panchayat Name</label>
                                <input type="text" class="form-control" id="bulkSchoolOrCollegeOrPanchayatName" name="schoolOrCollegeOrPanchayatName">
                                <div class="invalid-feedback">School/College/Panchayat Name is required if provided</div>
                            </div>
                            <div class="form-group">
                                <label for="bulkEventLocation"><i class="fas fa-map-marker-alt"></i> Event Location</label>
                                <input type="text" class="form-control" id="bulkEventLocation" name="eventLocation">
                                <div class="invalid-feedback">Event Location is required if provided</div>
                            </div>
                            <div class="form-group">
                                <label for="bulkEventDate"><i class="fas fa-calendar-alt"></i> Event Date (YYYY-MM-DD)</label>
                                <input type="text" class="form-control" id="bulkEventDate" name="eventDate">
                                <div class="invalid-feedback">Invalid date format (YYYY-MM-DD)</div>
                            </div>
                            <div class="form-group">
                                <label for="bulkNumberOfParticipants"><i class="fas fa-user-friends"></i> Number of Participants</label>
                                <input type="number" class="form-control" id="bulkNumberOfParticipants" name="numberOfParticipants">
                                <div class="invalid-feedback">Must be a number between 1 and 1000</div>
                            </div>
                            <div class="form-group">
                                <label for="bulkRemarks"><i class="fas fa-sticky-note"></i> Remarks</label>
                                <textarea class="form-control" id="bulkRemarks" name="remarks"></textarea>
                                <div class="invalid-feedback">Remarks is required if provided</div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal"><i class="fas fa-times"></i> Close</button>
                        <button type="button" class="btn btn-primary" id="saveBulkEdit"><i class="fas fa-save"></i> Save</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="confirmation-modal" id="confirmationModal">
            <div class="confirmation-modal-content">
                <h5><i class="fas fa-exclamation-circle"></i> Confirm Changes</h5>
                <p id="confirmationMessage"></p>
                <button class="btn btn-primary" id="confirmSave"><i class="fas fa-check"></i> Confirm</button>
                <button class="btn btn-secondary" id="cancelSave"><i class="fas fa-times"></i> Cancel</button>
            </div>
        </div>
        <div id="virtual-keyboard" class="virtual-keyboard container">
            <div class="keyboard-row">
                <button class="btn btn-light" onclick="typeKey('`')"><i class="fas fa-backquote"></i>`</button>
                <button class="btn btn-light" onclick="typeKey('1')">1</button>
                <button class="btn btn-light" onclick="typeKey('2')">2</button>
                <button class="btn btn-light" onclick="typeKey('3')">3</button>
                <button class="btn btn-light" onclick="typeKey('4')">4</button>
                <button class="btn btn-light" onclick="typeKey('5')">5</button>
                <button class="btn btn-light" onclick="typeKey('6')">6</button>
                <button class="btn btn-light" onclick="typeKey('7')">7</button>
                <button class="btn btn-light" onclick="typeKey('8')">8</button>
                <button class="btn btn-light" onclick="typeKey('9')">9</button>
                <button class="btn btn-light" onclick="typeKey('0')">0</button>
                <button class="btn btn-light" onclick="typeKey('-')">-</button>
                <button class="btn btn-light" onclick="typeKey('=')">=</button>
                <button class="btn btn-light wide-key" onclick="typeKey('backspace')"><i class="fas fa-backspace"></i> Backspace</button>
            </div>
            <div class="keyboard-row">
                <button class="btn btn-light special-key" onclick="typeKey('tab')"><i class="fas fa-arrow-right"></i> Tab</button>
                <button class="btn btn-light" onclick="typeKey('q')">Q</button>
                <button class="btn btn-light" onclick="typeKey('w')">W</button>
                <button class="btn btn-light" onclick="typeKey('e')">E</button>
                <button class="btn btn-light" onclick="typeKey('r')">R</button>
                <button class="btn btn-light" onclick="typeKey('t')">T</button>
                <button class="btn btn-light" onclick="typeKey('y')">Y</button>
                <button class="btn btn-light" onclick="typeKey('u')">U</button>
                <button class="btn btn-light" onclick="typeKey('i')">I</button>
                <button class="btn btn-light" onclick="typeKey('o')">O</button>
                <button class="btn btn-light" onclick="typeKey('p')">P</button>
                <button class="btn btn-light" onclick="typeKey('[')">[</button>
                <button class="btn btn-light" onclick="typeKey(']')">]</button>
                <button class="btn btn-light special-key" onclick="typeKey('\\')">\</button>
            </div>
            <div class="keyboard-row">
                <button class="btn btn-light special-key" onclick="typeKey('capslock')"><i class="fas fa-lock"></i> Caps Lock</button>
                <button class="btn btn-light" onclick="typeKey('a')">A</button>
                <button class="btn btn-light" onclick="typeKey('s')">S</button>
                <button class="btn btn-light" onclick="typeKey('d')">D</button>
                <button class="btn btn-light" onclick="typeKey('f')">F</button>
                <button class="btn btn-light" onclick="typeKey('g')">G</button>
                <button class="btn btn-light" onclick="typeKey('h')">H</button>
                <button class="btn btn-light" onclick="typeKey('j')">J</button>
                <button class="btn btn-light" onclick="typeKey('k')">K</button>
                <button class="btn btn-light" onclick="typeKey('l')">L</button>
                <button class="btn btn-light" onclick="typeKey(';')">;</button>
                <button class="btn btn-light" onclick="typeKey('\'')">'</button>
                <button class="btn btn-light wide-key" onclick="typeKey('enter')"><i class="fas fa-level-down-alt"></i> Enter</button>
            </div>
            <div class="keyboard-row">
                <button class="btn btn-light special-key" onclick="typeKey('shift')"><i class="fas fa-arrow-up"></i> Shift</button>
                <button class="btn btn-light" onclick="typeKey('z')">Z</button>
                <button class="btn btn-light" onclick="typeKey('x')">X</button>
                <button class="btn btn-light" onclick="typeKey('c')">C</button>
                <button class="btn btn-light" onclick="typeKey('v')">V</button>
                <button class="btn btn-light" onclick="typeKey('b')">B</button>
                <button class="btn btn-light" onclick="typeKey('n')">N</button>
                <button class="btn btn-light" onclick="typeKey('m')">M</button>
                <button class="btn btn-light" onclick="typeKey(',')">,</button>
                <button class="btn btn-light" onclick="typeKey('.')">.</button>
                <button class="btn btn-light" onclick="typeKey('/')">/</button>
                <button class="btn btn-light special-key" onclick="typeKey('shift')"><i class="fas fa-arrow-up"></i> Shift</button>
            </div>
            <div class="keyboard-row">
                <button class="btn btn-light special-key" onclick="typeKey('ctrl')"><i class="fas fa-cog"></i> Ctrl</button>
                <button class="btn btn-light" onclick="typeKey('win')"><i class="fab fa-windows"></i> Win</button>
                <button class="btn btn-light" onclick="typeKey('alt')"><i class="fas fa-keyboard"></i> Alt</button>
                <button class="btn btn-light extra-wide-key" onclick="typeKey(' ')"><i class="fas fa-space-bar"></i> Space</button>
                <button class="btn btn-light" onclick="typeKey('alt')"><i class="fas fa-keyboard"></i> Alt</button>
                <button class="btn btn-light" onclick="typeKey('win')"><i class="fab fa-windows"></i> Win</button>
                <button class="btn btn-light" onclick="typeKey('menu')"><i class="fas fa-bars"></i> Menu</button>
                <button class="btn btn-light" onclick="typeKey('ctrl')"><i class="fas fa-cog"></i> Ctrl</button>
                <button class="btn btn-light" onclick="typeKey('left')"><i class="fas fa-arrow-left"></i></button>
                <button class="btn btn-light" onclick="typeKey('up')"><i class="fas fa-arrow-up"></i></button>
                <button class="btn btn-light" onclick="typeKey('down')"><i class="fas fa-arrow-down"></i></button>
                <button class="btn btn-light" onclick="typeKey('right')"><i class="fas fa-arrow-right"></i></button>
            </div>
            <div class="keyboard-row">
                <button class="btn btn-light" onclick="typeKey('esc')"><i class="fas fa-power-off"></i> Esc</button>
                <button class="btn btn-light" onclick="typeKey('f1')">F1</button>
                <button class="btn btn-light" onclick="typeKey('f2')">F2</button>
                <button class="btn btn-light" onclick="typeKey('f3')">F3</button>
                <button class="btn btn-light" onclick="typeKey('f4')">F4</button>
                <button class="btn btn-light" onclick="typeKey('f5')">F5</button>
                <button class="btn btn-light" onclick="typeKey('f6')">F6</button>
                <button class="btn btn-light" onclick="typeKey('f7')">F7</button>
                <button class="btn btn-light" onclick="typeKey('f8')">F8</button>
                <button class="btn btn-light" onclick="typeKey('f9')">F9</button>
                <button class="btn btn-light" onclick="typeKey('f10')">F10</button>
                <button class="btn btn-light" onclick="typeKey('f11')">F11</button>
                <button class="btn btn-light" onclick="typeKey('f12')">F12</button>
            </div>
            <div class="keyboard-row">
                <button class="btn btn-light" onclick="typeKey('prtsc')"><i class="fas fa-camera"></i> PrtSc</button>
                <button class="btn btn-light" onclick="typeKey('scrLk')"><i class="fas fa-lock"></i> ScrLk</button>
                <button class="btn btn-light" onclick="typeKey('pause')"><i class="fas fa-pause"></i> Pause</button>
                <button class="btn btn-light" onclick="typeKey('ins')"><i class="fas fa-plus"></i> Ins</button>
                <button class="btn btn-light" onclick="typeKey('home')"><i class="fas fa-home"></i> Home</button>
                <button class="btn btn-light" onclick="typeKey('pgup')"><i class="fas fa-arrow-up"></i> PgUp</button>
                <button class="btn btn-light" onclick="typeKey('del')"><i class="fas fa-trash"></i> Del</button>
                <button class="btn btn-light" onclick="typeKey('end')"><i class="fas fa-step-forward"></i> End</button>
                <button class="btn btn-light" onclick="typeKey('pgdn')"><i class="fas fa-arrow-down"></i> PgDn</button>
                <button class="btn btn-light" onclick="typeKey('numlock')"><i class="fas fa-lock"></i> NumLk</button>
                <button class="btn btn-light" onclick="typeKey('/')">/</button>
                <button class="btn btn-light" onclick="typeKey('*')">*</button>
                <button class="btn btn-light" onclick="typeKey('-')">-</button>
            </div>
            <div class="keyboard-row">
                <button class="btn btn-light" onclick="typeKey('num7')">7</button>
                <button class="btn btn-light" onclick="typeKey('num8')">8</button>
                <button class="btn btn-light" onclick="typeKey('num9')">9</button>
                <button class="btn btn-light" onclick="typeKey('+')">+</button>
                <button class="btn btn-light" onclick="typeKey('num4')">4</button>
                <button class="btn btn-light" onclick="typeKey('num5')">5</button>
                <button class="btn btn-light" onclick="typeKey('num6')">6</button>
                <button class="btn btn-light" onclick="typeKey('num1')">1</button>
                <button class="btn btn-light" onclick="typeKey('num2')">2</button>
                <button class="btn btn-light" onclick="typeKey('num3')">3</button>
                <button class="btn btn-light" onclick="typeKey('num0')">0</button>
                <button class="btn btn-light" onclick="typeKey('num.')">.</button>
                <button class="btn btn-light special-key" onclick="typeKey('numenter')"><i class="fas fa-level-down-alt"></i> Enter</button>
            </div>
        </div>
        <h2 class="text-center mt-4" style="font-family: 'Segoe UI', sans-serif; font-size: 36px; color: var(--btn-primary-bg);"><i class="fas fa-list-alt"></i> Activities List</h2>
        <table class="table table-bordered table-striped" id="activityTable" role="grid" aria-labelledby="activityTableDesc">
            <caption id="activityTableDesc" class="sr-only">List of activities with details and operations</caption>
            <thead>
                <tr>
                    <th data-col="select" class="draggable"><i class="fas fa-check-square"></i> Select</th>
                    <th data-col="id" class="draggable"><i class="fas fa-id-badge"></i> ID</th>
                    <th data-col="state" class="draggable"><i class="fas fa-map"></i> State</th>
                    <th data-col="stationName" class="draggable"><i class="fas fa-building"></i> Station Name</th>
                    <th data-col="activityType" class="draggable"><i class="fas fa-tasks"></i> Activity Type</th>
                    <th data-col="eventCategory" class="draggable"><i class="fas fa-tag"></i> Event Category</th>
                    <th data-col="participantCategory" class="draggable"><i class="fas fa-users"></i> Participant Category</th>
                    <th data-col="eventDescription" class="draggable"><i class="fas fa-comment"></i> Event Description</th>
                    <th data-col="schoolOrCollegeOrPanchayatName" class="draggable"><i class="fas fa-school"></i> School/College/Panchayat Name</th>
                    <th data-col="eventLocation" class="draggable"><i class="fas fa-map-marker-alt"></i> Event Location</th>
                    <th data-col="eventDate" class="draggable"><i class="fas fa-calendar-alt"></i> Event Date</th>
                    <th data-col="numberOfParticipants" class="draggable"><i class="fas fa-user-friends"></i> Number of Participants</th>
                    <th data-col="remarks" class="draggable"><i class="fas fa-sticky-note"></i> Remarks</th>
                    <th data-col="actions" class="draggable"><i class="fas fa-cogs"></i> Operations</th>
                </tr>
            </thead>
            <tbody id="sortableBody" data-sort-order="asc">
                <tr th:each="activity : ${activities}" th:attr="data-row-id=${activity.id},data-id=${activity.id}">
                    <td data-label="Select" data-col="select"><input type="checkbox" class="selectRow" th:value="${activity.id}" aria-label="Select activity"></td>
                    <td data-label="ID" th:text="${activity.id}" scope="row" class="activity-id" data-col="id"></td>
                    <td data-label="State" class="editable" th:data-field="state" th:data-id="${activity.id}" data-col="state">
                        <span th:text="${activity.state}"></span>
                    </td>
                    <td data-label="Station Name" class="editable" th:data-field="stationName" th:data-id="${activity.id}" data-col="stationName">
                        <span th:text="${activity.stationName}"></span>
                    </td>
                    <td data-label="Activity Type" class="editable" th:data-field="activityType" th:data-id="${activity.id}" th:text="${activity.activityType}" data-col="activityType"><div class="error-message">Activity Type is required</div></td>
                    <td data-label="Event Category" class="editable" th:data-field="eventCategory" th:data-id="${activity.id}" th:text="${activity.eventCategory}" data-col="eventCategory"><div class="error-message">Event Category is required</div></td>
                    <td data-label="Participant Category" class="editable" th:data-field="participantCategory" th:data-id="${activity.id}" th:utext="${activity.participantCategory}" data-col="participantCategory"><div class="error-message">Participant Category is required</div></td>
                    <td data-label="Event Description" class="editable" th:data-field="eventDescription" th:data-id="${activity.id}" th:utext="${activity.eventDescription}" data-col="eventDescription"><div class="error-message">Event Description is required</div></td>
                    <td data-label="School/College/Panchayat Name" class="editable" th:data-field="schoolOrCollegeOrPanchayatName" th:data-id="${activity.id}" data-col="schoolOrCollegeOrPanchayatName">
                        <span th:text="${activity.schoolOrCollegeOrPanchayatName}"></span>
                    </td>
                    <td data-label="Event Location" class="editable" th:data-field="eventLocation" th:data-id="${activity.id}" data-col="eventLocation">
                        <span th:text="${activity.eventLocation}"></span>
                    </td>
                    <td data-label="Event Date" class="editable" th:data-field="eventDate" th:data-id="${activity.id}" th:text="${activity.eventDate}" data-col="eventDate"><div class="error-message">Invalid date format (YYYY-MM-DD)</div></td>
                    <td data-label="Number of Participants" class="editable" th:data-field="numberOfParticipants" th:data-id="${activity.id}" th:text="${activity.numberOfParticipants}" data-col="numberOfParticipants"><div class="error-message">Must be a positive number</div></td>
                    <td data-label="Remarks" class="editable" th:data-field="remarks" th:data-id="${activity.id}" th:utext="${activity.remarks}" data-col="remarks"><div class="error-message">Remarks cannot be empty if provided</div></td>
                    <td data-label="Operations" class="actions" data-col="actions">
                        <button class="btn btn-sm btn-info upload-btn" th:attr="data-id=${activity.id}" aria-label="Upload files for activity ${activity.id}"><i class="fas fa-upload"></i> Upload</button>
                        <input type="file" class="upload-input" th:attr="data-id=${activity.id}" multiple style="display: none;" aria-label="Select files to upload for activity ${activity.id}">
                        <a th:href="@{/update/{id}(id=${activity.id})}" class="btn btn-sm btn-warning" aria-label="Edit activity ${activity.id}"><i class="fas fa-edit"></i> Edit</a>
                        <div class="dropdown" th:if="${fileMap.get(activity.id)?.size() > 0}">
                            <button class="btn btn-sm btn-primary download-btn" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" th:attr="data-id=${activity.id}">
                                <i class="fas fa-download"></i> Download
                            </button>
                            <div class="dropdown-menu">
                                <a class="dropdown-item" th:each="file : ${fileMap.get(activity.id)}" th:href="@{'/api/download/' + ${file.id}}" th:text="${file.fileName}"></a>
                                <div class="dropdown-divider"></div>
                                <a class="dropdown-item text-danger delete-files" th:attr="data-id=${activity.id}"><i class="fas fa-trash-alt"></i> Delete All Images</a>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-primary download-btn" disabled th:unless="${fileMap.get(activity.id)?.size() > 0}" th:attr="data-id=${activity.id}" aria-label="No images available for activity ${activity.id}"><i class="fas fa-download"></i> Download</button>
                    </td>
                </tr>
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="11">Total</td>
                    <td th:text="${summary?.totalParticipants != null ? summary.totalParticipants : '0'}" data-col="numberOfParticipants"></td>
                    <td data-col="remarks"></td>
                    <td data-col="actions"></td>
                </tr>
            </tfoot>
        </table>
        <div class="pagination-section mt-4">
            <div>
                <label for="pageSizeSelect" class="mr-2"><i class="fas fa-list-ol"></i> Entries per page:</label>
                <select id="pageSizeSelect" class="form-control page-size-select" aria-label="Select entries per page">
                    <option value="10" th:selected="${size == 10}">10</option>
                    <option value="20" th:selected="${size == 20}">20</option>
                    <option value="50" th:selected="${size == 50}">50</option>
                    <option value="100" th:selected="${size == 100}">100</option>
                    <option value="500" th:selected="${size == 500}">500</option>
                    <option value="1000" th:selected="${size == 1000}">1000</option>
                </select>
            </div>
            <nav aria-label="Page navigation">
                <ul class="pagination">
                    <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                        <a class="page-link" th:href="@{/activity(page=${currentPage - 1},size=${size},sortBy=${sortBy},sortDir=${sortDir})}" aria-label="Previous page"><i class="fas fa-arrow-left"></i> Previous</a>
                    </li>
                    <li class="page-item" th:each="i : ${#numbers.sequence(0, totalPages - 1)}" th:classappend="${i == currentPage} ? 'active'">
                        <a class="page-link" th:href="@{/activity(page=${i},size=${size},sortBy=${sortBy},sortDir=${sortDir})}" th:text="${i + 1}" th:attr="aria-label='Page ' + ${i + 1}"></a>
                    </li>
                    <li class="page-item" th:classappend="${currentPage >= totalPages - 1} ? 'disabled'">
                        <a class="page-link" th:href="@{/activity(page=${currentPage + 1},size=${size},sortBy=${sortBy},sortDir=${sortDir})}" aria-label="Next page">Next <i class="fas fa-arrow-right"></i></a>
                    </li>
                </ul>
            </nav>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-2xl font-semibold mb-4"><i class="fas fa-calculator"></i> Calculate</h2>
            <form id="calculationForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium"><i class="fas fa-cogs"></i> Aggregate Functions and Columns</label>
                    <div id="aggregateFunctions" class="space-y-2">
                        <div class="flex space-x-2 aggregate-row">
                            <select class="border p-2 rounded function">
                                <option value="COUNT">COUNT</option>
                                <option value="SUM">SUM</option>
                                <option value="AVG">AVG</option>
                                <option value="MIN">MIN</option>
                                <option value="MAX">MAX</option>
                            </select>
                            <select class="border p-2 rounded column">
                                <option value="state">State</option>
                                <option value="stationName">Station Name</option>
                                <option value="eventCategory">Event Category</option>
                                <option value="participantCategory">Participant Category</option>
                                <option value="numberOfParticipants">Number of Participants</option>
                                <option value="eventDate">Event Date</option>
                            </select>
                            <button type="button" class="bg-red-500 text-white px-2 py-1 rounded remove-aggregate"><i class="fas fa-trash"></i> Remove</button>
                        </div>
                    </div>
                    <button type="button" id="addAggregate" class="bg-blue-500 text-white px-2 py-1 rounded mt-2"><i class="fas fa-plus"></i> Add Aggregate</button>
                </div>
                <div>
                    <label class="block text-sm font-medium"><i class="fas fa-layer-group"></i> Group By</label>
                    <select id="groupBy1" class="border p-2 rounded w-full">
                        <option value="">None</option>
                        <option value="state">State</option>
                        <option value="stationName">Station Name</option>
                        <option value="eventCategory">Event Category</option>
                        <option value="participantCategory">Participant Category</option>
                        <option value="eventDate">Event Date</option>
                    </select>
                    <select id="groupBy2" class="border p-2 rounded w-full mt-2">
                        <option value="">None</option>
                        <option value="state">State</option>
                        <option value="stationName">Station Name</option>
                        <option value="eventCategory">Event Category</option>
                        <option value="participantCategory">Participant Category</option>
                        <option value="eventDate">Event Date</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium"><i class="fas fa-filter"></i> Where Conditions</label>
                    <div id="whereConditions" class="space-y-2">
                        <div class="flex space-x-2 condition-row">
                            <select class="border p-2 rounded field">
                                <option value="state">State</option>
                                <option value="stationName">Station Name</option>
                                <option value="eventCategory">Event Category</option>
                                <option value="participantCategory">Participant Category</option>
                                <option value="numberOfParticipants">Number of Participants</option>
                                <option value="eventDate">Event Date</option>
                            </select>
                            <select class="border p-2 rounded operator">
                                <option value="=">=</option>
                                <option value="!=">!=</option>
                                <option value="<"><</option>
                                <option value=">">></option>
                                <option value="<="><=</option>
                                <option value=">=">>=</option>
                            </select>
                            <input type="text" class="border p-2 rounded value flex-1" placeholder="Value">
                            <select class="border p-2 rounded logical hidden">
                                <option value="AND">AND</option>
                                <option value="OR">OR</option>
                            </select>
                            <button type="button" class="bg-red-500 text-white px-2 py-1 rounded remove-condition"><i class="fas fa-trash"></i> Remove</button>
                        </div>
                    </div>
                    <button type="button" id="addCondition" class="bg-blue-500 text-white px-2 py-1 rounded mt-2"><i class="fas fa-plus"></i> Add Condition</button>
                </div>
                <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded"><i class="fas fa-calculator"></i> Calculate</button>
            </form>
            <div id="calculationResults" class="mt-4">
                <h3 class="text-lg font-medium"><i class="fas fa-table"></i> Results</h3>
                <table class="w-full border">
                    <thead id="resultsHeader" class="bg-gray-200">
                        <tr></tr>
                    </thead>
                    <tbody id="resultsTable"></tbody>
                </table>
            </div>
        </div>
    </div>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.bundle.min.js" integrity="sha384-pjaaA8dDz/5BgdFUPX6M/9SUZv4d12SUPF0axWc+VRZkx5xU3daN+lYb49+Ax+Tl" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize theme from localStorage
        if (localStorage.getItem('theme') === 'dark') {
            document.body.setAttribute('data-theme', 'dark');
        }

        // Show/Hide Spinner
        function showSpinner() {
            document.getElementById('spinner').style.display = 'block';
        }
        function hideSpinner() {
            document.getElementById('spinner').style.display = 'none';
        }
        // Table Search with Highlighting
       function toggleKeyboard() {
            const keyboard = document.getElementById('virtual-keyboard');
            keyboard.style.display = keyboard.style.display === 'none' ? 'block' : 'none';
        }

        function typeKey(key) {
            const input = document.getElementById('searchInput');
            if (input) {
                if (key === 'backspace') {
                    input.value = input.value.substring(0, input.value.length - 1);
                } else {
                    input.value += key;
                }
                input.dispatchEvent(new Event('input'));
                searchTable();
            }
        }

        function searchTable() {
            const input = document.getElementById('searchInput').value.toLowerCase();
            const table = document.getElementById('activitiesTable');
            const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

            for (let row of rows) {
                let match = false;
                const cells = row.getElementsByTagName('td');
                for (let i = 2; i < cells.length - 1; i++) {
                    let cellText = cells[i].textContent.toLowerCase();
                    if (cellText.includes(input)) {
                        match = true;
                        if (input) {
                            const regex = new RegExp(`(${input})`, 'gi');
                            cells[i].innerHTML = cells[i].textContent.replace(regex, '<span class="highlight">$1</span>');
                        } else {
                            cells[i].innerHTML = cells[i].textContent;
                        }
                    } else {
                        cells[i].innerHTML = cells[i].textContent;
                    }
                }
                row.style.display = match || !input ? '' : 'none';
            }
        }
        // Attach search event listener
        document.getElementById('searchInput').addEventListener('input', searchTable);
        // Drag-and-Drop Row Reordering
        var sortable = Sortable.create(document.getElementById('sortableBody'), {
            animation: 150,
            handle: '.selectRow',
            onEnd: function (evt) {
                var orderList = [];
                document.querySelectorAll('#sortableBody tr').forEach((row, index) => {
                    orderList.push({ id: parseInt(row.dataset.id), orderIndex: index });
                });
                showSpinner();
                fetch('/reorder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderList)
                }).then(response => {
                    if (!response.ok) {
                        alert('Failed to reorder activities.');
                    }
                }).catch(error => {
                    console.error('Reorder failed:', error);
                    alert('Failed to reorder activities.');
                }).finally(hideSpinner);
            }
        });

        $(document).ready(function() {
            // Add new aggregate function row
            $('#addAggregate').click(function() {
                const aggregateRow = `
                    <div class="flex space-x-2 aggregate-row">
                        <select class="border p-2 rounded function">
                            <option value="COUNT">COUNT</option>
                            <option value="SUM">SUM</option>
                            <option value="AVG">AVG</option>
                            <option value="MIN">MIN</option>
                            <option value="MAX">MAX</option>
                        </select>
                        <select class="border p-2 rounded column">
                            <option value="state">State</option>
                            <option value="stationName">Station Name</option>
                            <option value="eventCategory">Event Category</option>
                            <option value="participantCategory">Participant Category</option>
                            <option value="numberOfParticipants">Number of Participants</option>
                            <option value="eventDate">Event Date</option>
                        </select>
                        <button type="button" class="bg-red-500 text-white px-2 py-1 rounded remove-aggregate">Remove</button>
                    </div>`;
                $('#aggregateFunctions').append(aggregateRow);
            });

            // Remove aggregate function row
            $(document).on('click', '.remove-aggregate', function() {
                $(this).closest('.aggregate-row').remove();
            });

            // Add new condition row
            $('#addCondition').click(function() {
                const conditionRow = `
                    <div class="flex space-x-2 condition-row">
                        <select class="border p-2 rounded field">
                            <option value="state">State</option>
                            <option value="stationName">Station Name</option>
                            <option value="eventCategory">Event Category</option>
                            <option value="participantCategory">Participant Category</option>
                            <option value="numberOfParticipants">Number of Participants</option>
                            <option value="eventDate">Event Date</option>
                        </select>
                        <select class="border p-2 rounded operator">
                            <option value="=">=</option>
                            <option value="!=">!=</option>
                            <option value="<"><</option>
                            <option value=">">></option>
                            <option value="<="><=</option>
                            <option value=">=">>=</option>
                        </select>
                        <input type="text" class="border p-2 rounded value flex-1" placeholder="Value">
                        <select class="border p-2 rounded logical">
                            <option value="AND">AND</option>
                            <option value="OR">OR</option>
                        </select>
                        <button type="button" class="bg-red-500 text-white px-2 py-1 rounded remove-condition">Remove</button>
                    </div>`;
                $('#whereConditions').append(conditionRow);
                updateLogicalOperators();
            });

            // Remove condition row
            $(document).on('click', '.remove-condition', function() {
                $(this).closest('.condition-row').remove();
                updateLogicalOperators();
            });

            // Update logical operator visibility
            function updateLogicalOperators() {
                $('#whereConditions .condition-row').each(function(index) {
                    $(this).find('.logical').toggle(index < $('#whereConditions .condition-row').length - 1);
                });
            }

            // Handle form submission
            $('#calculationForm').submit(function(e) {
                e.preventDefault();
                const aggregates = [];
                $('#aggregateFunctions .aggregate-row').each(function() {
                    const functionName = $(this).find('.function').val();
                    const column = $(this).find('.column').val();
                    aggregates.push({ function: functionName, column });
                });
                const groupBy = [$('#groupBy1').val(), $('#groupBy2').val()].filter(val => val);
                const conditions = [];
                $('#whereConditions .condition-row').each(function() {
                    const field = $(this).find('.field').val();
                    const operator = $(this).find('.operator').val();
                    const value = $(this).find('.value').val();
                    const logical = $(this).find('.logical').val();
                    conditions.push({ field, operator, value, logical });
                });

                $.ajax({
                    url: '/api/dynamicCalculation',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        aggregates,
                        groupBy,
                        conditions
                    }),
                    success: function(response) {
                        if (response.errorMessage) {
                            $('#resultsHeader tr').html('<th class="border p-2">Error</th>');
                            $('#resultsTable').html(`<tr><td class="border p-2 text-red-500">${response.errorMessage}</td></tr>`);
                        } else {
                            // Build dynamic table header
                            let headerHtml = '';
                            if (response.results && response.results.length > 0) {
                                const firstResult = response.results[0];
                                if (groupBy.length > 0) {
                                    groupBy.forEach(group => {
                                        headerHtml += `<th class="border p-2">${group}</th>`;
                                    });
                                }
                                aggregates.forEach(agg => {
                                    headerHtml += `<th class="border p-2">${agg.function}(${agg.column})</th>`;
                                });
                                $('#resultsHeader tr').html(headerHtml);

                                // Build table rows
                                let rowsHtml = '';
                                response.results.forEach(result => {
                                    let rowHtml = '<tr>';
                                    if (groupBy.length > 0) {
                                        groupBy.forEach(group => {
                                            rowHtml += `<td class="border p-2">${result.groups[group] || 'N/A'}</td>`;
                                        });
                                    }
                                    aggregates.forEach(agg => {
                                        const key = `${agg.function}_${agg.column}`;
                                        rowHtml += `<td class="border p-2">${result.values[key] !== null ? result.values[key] : 'N/A'}</td>`;
                                    });
                                    rowHtml += '</tr>';
                                    rowsHtml += rowHtml;
                                });
                                $('#resultsTable').html(rowsHtml);
                            } else {
                                $('#resultsHeader tr').html(aggregates.map(agg => `<th class="border p-2">${agg.function}(${agg.column})</th>`).join(''));
                                let rowHtml = '<tr>' + aggregates.map(agg => {
                                    const key = `${agg.function}_${agg.column}`;
                                    return `<td class="border p-2">${response.values[key] !== null ? response.values[key] : 'N/A'}</td>`;
                                }).join('') + '</tr>';
                                $('#resultsTable').html(rowHtml);
                            }
                        }
                    },
                    error: function() {
                        $('#resultsHeader tr').html('<th class="border p-2">Error</th>');
                        $('#resultsTable').html('<tr><td class="border p-2 text-red-500">Error performing calculation</td></tr>');
                    }
                });
            });
        });

        const table = document.getElementById('activityTable');
        const headers = table.querySelectorAll('th.draggable');
        let selectedHeader = null;

        headers.forEach(header => {
            // Single click for reordering
            header.addEventListener('click', (e) => {
                e.preventDefault();
                if (!selectedHeader) {
                    selectedHeader = header;
                    header.classList.add('selected');
                } else if (selectedHeader === header) {
                    header.classList.remove('selected');
                    selectedHeader = null;
                } else {
                    const fromIndex = selectedHeader.cellIndex;
                    const toIndex = header.cellIndex;
                    reorderColumns(fromIndex, toIndex);
                    selectedHeader.classList.remove('selected');
                    selectedHeader = null;
                }
            });
        });

        function reorderColumns(fromIndex, toIndex) {
            const rows = table.querySelectorAll('tr');
            rows.forEach(row => {
                const cells = Array.from(row.cells);
                const cellToMove = cells[fromIndex];
                if (fromIndex < toIndex) {
                    cells[toIndex].after(cellToMove);
                } else {
                    cells[toIndex].before(cellToMove);
                }
            });
        }

        // Toggle Dark Mode
        document.getElementById('toggleDarkMode').addEventListener('click', () => {
            const body = document.body;
            const theme = body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
        });
     // Table Search with Highlighting
        function searchTable() {
            const input = document.getElementById('searchInput');
            const filter = input.value.toLowerCase();
            const table = document.getElementById('activityTable');
            const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

            // Reset all cells to original content
            for (let row of rows) {
                const cells = row.getElementsByTagName('td');
                for (let i = 1; i < cells.length - 1; i++) { // Skip select and operations
                    const cell = cells[i];
                    const originalContent = cell.getAttribute('data-original') || cell.textContent;
                    cell.innerHTML = originalContent;
                    cell.setAttribute('data-original', originalContent); // Store original content
                }
            }

            // Apply highlighting and filter rows if search term exists
            for (let row of rows) {
                let match = false;
                const cells = row.getElementsByTagName('td');
                for (let i = 1; i < cells.length - 1; i++) { // Skip select and operations
                    const cell = cells[i];
                    const text = cell.textContent.toLowerCase();
                    if (text.includes(filter)) {
                        match = true;
                        if (filter) {
                            const regex = new RegExp(`(${filter})`, 'gi');
                            cell.innerHTML = cell.getAttribute('data-original').replace(regex, '<span class="text-highlight">$1</span>');
                        }
                    }
                }
                row.style.display = match || !filter ? '' : 'none';
            }
        }

        // Toggle Virtual Keyboard
        function toggleKeyboard() {
            const keyboard = document.getElementById('virtual-keyboard');
            keyboard.style.display = keyboard.style.display === 'none' ? 'block' : 'none';
        }

        // Type Key for Virtual Keyboard
        function typeKey(key) {
            const input = document.getElementById('searchInput');
            if (input) {
                if (key === 'backspace') {
                    input.value = input.value.substring(0, input.value.length - 1);
                } else if (key === 'capslock' || key === 'shift' || key === 'ctrl' || key === 'alt' || key === 'win' || key === 'menu' ||
                           key === 'esc' || key.includes('f') || key === 'prtsc' || key === 'scrLk' || key === 'pause' ||
                           key === 'ins' || key === 'home' || key === 'pgup' || key === 'del' || key === 'end' || key === 'pgdn' ||
                           key === 'numlock' || key === 'left' || key === 'up' || key === 'down' || key === 'right' || key === 'numenter') {
                    // Ignore modifier and navigation keys
                    return;
                } else if (key === 'tab') {
                    input.value += '\t';
                } else if (key === 'enter') {
                    input.value += '\n';
                } else if (key.startsWith('num') && key.length > 3) {
                    input.value += key.substring(3); // Extract number from num7, num8, etc.
                } else {
                    input.value += key;
                }
                input.dispatchEvent(new Event('input'));
                searchTable();
            }
        }

        // Attach search event listener
        document.getElementById('searchInput').addEventListener('input', searchTable);
        // Attach search event listener
        document.getElementById('searchInput').addEventListener('input', searchTable);
        //Select column 
       document.querySelector('.columns-toggle button').addEventListener('click', function() {
    const dropdown = this.nextElementSibling;
    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
});

document.querySelectorAll('.column-toggle-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        const columnIndex = this.getAttribute('data-column');
        const table = document.getElementById('activityTable');
        const rows = table.querySelectorAll('tr');
        rows.forEach(row => {
            const cell = row.cells[columnIndex];
            if (cell) {
                cell.style.display = this.checked ? '' : 'none';
            }
        });
    });
});
// Sorting functionality
document.querySelector('.sort-columns button').addEventListener('click', function() {
    const dropdown = this.nextElementSibling;
    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
});

document.querySelectorAll('.sort-columns .dropdown button').forEach(button => {
    button.addEventListener('click', function() {
        const columnIndex = this.getAttribute('data-column');
        const order = this.classList.contains('asc') ? 'asc' : 'desc';
        const table = document.getElementById('activityTable');
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));

        rows.sort((a, b) => {
            let aValue = a.cells[columnIndex].textContent.trim();
            let bValue = b.cells[columnIndex].textContent.trim();

            // Handle numeric columns (e.g., ID, Number of Participants)
            if (columnIndex === '1' || columnIndex === '11') {
                aValue = parseFloat(aValue) || 0;
                bValue = parseFloat(bValue) || 0;
            }
            // Handle date column (Event Date)
            else if (columnIndex === '10') {
                aValue = aValue ? new Date(aValue) : new Date(0);
                bValue = bValue ? new Date(bValue) : new Date(0);
            }

            if (order === 'asc') {
                return aValue > bValue ? 1 : aValue < bValue ? -1 : 0;
            } else {
                return aValue < bValue ? 1 : aValue > bValue ? -1 : 0;
            }
        });

        // Clear and re-append sorted rows
        tbody.innerHTML = '';
        rows.forEach(row => tbody.appendChild(row));

        // Hide the dropdown after sorting
        this.closest('.dropdown').style.display = 'none';
    });
});

        // Pagination: Handle page size change
        document.getElementById('pageSizeSelect').addEventListener('change', () => {
            const size = document.getElementById('pageSizeSelect').value;
            const params = new URLSearchParams(window.location.search);
            params.set('page', '0');
            params.set('size', size);
            window.location.href = `/activity?${params.toString()}`;
        });


        // Data Validation
        function validateField(field, value) {
            const validations = {
                state: v => !v || v.trim().length > 0,
                stationName: v => !v || v.trim().length > 0,
                activityType: v => !v || v.trim().length > 0,
                eventCategory: v => !v || v.trim().length > 0,
                participantCategory: v => !v || v.trim().length > 0,
                eventDescription: v => !v || v.trim().length > 0,
                schoolOrCollegeOrPanchayatName: v => !v || v.trim().length > 0,
                eventLocation: v => !v || v.trim().length > 0,
                eventDate: v => !v || /^\d{4}-\d{2}-\d{2}$/.test(v.trim()),
                numberOfParticipants: v => !v || (!isNaN(v) && parseInt(v) >= 1 && parseInt(v) <= 1000),
                remarks: v => !v || v.trim().length > 0
            };
            return validations[field] ? validations[field](value) : true;
        }
        $(document).ready(function() {
            $('.editable').click(function() {
                if ($(this).hasClass('editing')) return;
                
                var originalContent = $(this).text().trim();
                var field = $(this).data('field');
                var id = $(this).data('id');
                var inputType = field === 'numberOfParticipants' ? 'number' : field === 'eventDate' ? 'date' : field === 'eventDescription' || field === 'remarks' ? 'textarea' : 'text';
                
                $(this).addClass('editing');
                $(this).html(`
                    ${inputType === 'textarea' ? `<textarea class="form-control form-control-sm">${originalContent}</textarea>` : `<input type="${inputType}" class="form-control form-control-sm" value="${originalContent}">`}
                    <span class="edit-buttons">
                        <button class="btn btn-sm btn-success" onclick="saveEdit(${id}, '${field}', this)">✔</button>
                        <button class="btn btn-sm btn-danger" onclick="cancelEdit(this)">✖</button>
                    </span>
                    <div class="error-message">${$(this).find('.error-message').text()}</div>
                `);
                $(this).find(inputType === 'textarea' ? 'textarea' : 'input').focus();
            });
        });

        function saveEdit(id, field, button) {
            var td = $(button).closest('td');
            var newValue = td.find('input, textarea').val();
            var isValid = validateField(field, newValue);
            if (!isValid) {
                td.addClass('is-invalid');
                td.find('.error-message').show();
                return;
            }
            showSpinner();
            $.ajax({
                url: '/inlineUpdate',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ id: id, field: field, value: newValue }),
                success: function() {
                    td.removeClass('editing').removeClass('is-invalid');
                    td.find('.error-message').hide();
                    td.text(newValue);
                    td.append(`<div class="error-message">${td.find('.error-message').text()}</div>`);
                },
                error: function(xhr) {
                    var error = xhr.responseJSON ? xhr.responseJSON.errorMessage : 'Error updating field';
                    alert(error);
                    cancelEdit(button);
                },
                complete: hideSpinner
            });
        }

        function cancelEdit(button) {
            var td = $(button).closest('td');
            var originalContent = td.find('input, textarea').val();
            td.removeClass('editing').removeClass('is-invalid');
            td.find('.error-message').hide();
            td.text(originalContent);
            td.append(`<div class="error-message">${td.find('.error-message').text()}</div>`);
        }
        // Active Record & Field Context
        document.querySelectorAll('.selectRow').forEach(cb => {
            cb.addEventListener('change', () => {
                const row = cb.closest('tr');
                row.classList.toggle('active-row', cb.checked);
                updateSelectedCount();
            });
        });

        document.querySelectorAll('.editable').forEach(cell => {
            cell.addEventListener('focus', () => {
                document.querySelectorAll('.editable').forEach(c => c.classList.remove('active'));
                cell.classList.add('active');
                cell.closest('tr').classList.add('active-row');
            });
            cell.addEventListener('blur', () => {
                cell.classList.remove('active');
                if (!cell.closest('tr').querySelector('.selectRow:checked')) {
                    cell.closest('tr').classList.remove('active-row');
                }
            });
            cell.addEventListener('input', () => {
                const field = cell.dataset.field;
                const value = cell.textContent.trim();
                const isValid = validateField(field, value);
                cell.classList.toggle('is-invalid', !isValid);
                cell.querySelector('.invalid-feedback').style.display = isValid ? 'none' : 'block';
            });
        });
     // Handle File Upload
        document.querySelectorAll('.upload-btn').forEach(button => {
            button.addEventListener('click', () => {
                const activityId = button.dataset.id;
                const fileInput = button.nextElementSibling;
                fileInput.click();
            });
        });
        document.getElementById('exportCsv').addEventListener('click', () => {
            showSpinner();
            const feedback = document.createElement('div');
            feedback.className = 'alert alert-info mt-2';
            feedback.textContent = 'Exporting...';
            document.querySelector('.container').prepend(feedback);
            const rows = document.querySelectorAll('#activityTable tr');
            let csv = 'ID,State,Station Name,Activity Type,Event Category,Participant Category,Event Description,School/College/Panchayat Name,Event Location,Event Date,Number of Participants,Remarks,Images\n';
            rows.forEach(row => {
                const cells = Array.from(row.cells).slice(1, -1).map(cell => {
                    if (cell.style.display === 'none') return '';
                    let content = cell.classList.contains('download-link') 
                        ? Array.from(cell.querySelectorAll('a.download-link')).map(a => a.textContent).join(',')
                        : cell.textContent;
                    return `"${content.replace(/"/g, '""')}"`;
                }).filter(cell => cell !== '');
                csv += cells.join(',') + '\n';
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'activities.csv';
            a.click();
            URL.revokeObjectURL(url);
            feedback.textContent = 'Export completed!';
            setTimeout(() => feedback.remove(), 2000);
            hideSpinner();
        });
        document.querySelectorAll('.upload-input').forEach(input => {
            input.addEventListener('change', () => {
                const activityId = input.dataset.id;
                const files = input.files;
                if (files.length === 0) return;

                const formData = new FormData();
                for (let i = 0; i < files.length; i++) {
                    formData.append('files', files[i]);
                }
                formData.append('activityId', activityId);

                showConfirmation(`Upload ${files.length} file(s) for activity ${activityId}?`, () => {
                    showSpinner();
                    $.ajax({
                        url: '/api/upload',
                        method: 'POST',
                        data: formData,
                        contentType: false,
                        processData: false,
                        success: (response) => {
                            alert(response.message);
                            window.location.reload();
                        },
                        error: (xhr) => {
                            alert('Failed to upload files: ' + (xhr.responseJSON?.errorMessage || 'Unknown error'));
                        },
                        complete: hideSpinner
                    });
                });
                input.value = ''; // Reset file input
            });
        });
     // Handle Individual File Deletion
        document.querySelectorAll('.delete-file').forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                const fileId = button.dataset.id;
                const activityId = button.dataset.activityId;
                if (confirm(`Are you sure you want to delete this file for activity ${activityId}?`)) {
                    showSpinner();
                    fetch(`/api/file/${fileId}`, {
                        method: 'DELETE'
                    }).then(response => {
                        if (response.ok) {
                            alert('File deleted successfully!');
                            window.location.reload();
                        } else {
                            alert('Failed to delete file.');
                        }
                    }).catch(error => {
                        console.error('Delete file failed:', error);
                        alert('Failed to delete file.');
                    }).finally(hideSpinner);
                }
            });
        });
        $(document).ready(function() {
            let zoomLevel = 1; // Default zoom level (100%)
            const minZoom = 0.25; // 25%
            const maxZoom = 5; // 500%
            const zoomStep = 0.25; // 25% increments

            $('#quickActionsButton').click(function() {
                $('#quickActionsMenu').toggleClass('hidden');
            });

            // Close Quick Actions menu when clicking outside
            $(document).click(function(event) {
                if (!$(event.target).closest('#quickActionsButton, #quickActionsMenu').length) {
                    $('#quickActionsMenu').addClass('hidden');
                }
            });

            // Zoom In button
            $('#zoomIn').click(function() {
                if (zoomLevel < maxZoom) {
                    zoomLevel = Math.min(zoomLevel + zoomStep, maxZoom);
                    $('#dashboardSection').css({
                        'transform': `scale(${zoomLevel})`,
                        'width': `${100 / zoomLevel}%`
                    });
                }
            });

            // Zoom Out button
            $('#zoomOut').click(function() {
                if (zoomLevel > minZoom) {
                    zoomLevel = Math.max(zoomLevel - zoomStep, minZoom);
                    $('#dashboardSection').css({
                        'transform': `scale(${zoomLevel})`,
                        'width': `${100 / zoomLevel}%`
                    });
                }
            });
            const table = document.getElementById('activityTable');
            const headers = table.querySelectorAll('th.draggable');
            let selectedHeader = null;

            headers.forEach(header => {
                // Single click for reordering
                header.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (!selectedHeader) {
                        selectedHeader = header;
                        header.classList.add('selected');
                    } else if (selectedHeader !== header) {
                        // Swap columns
                        const fromIndex = selectedHeader.cellIndex;
                        const toIndex = header.cellIndex;
                        reorderColumns(fromIndex, toIndex);
                        selectedHeader.classList.remove('selected');
                        selectedHeader = null;
                    } else {
                        // Clicking the same header again deselects it
                        header.classList.remove('selected');
                        selectedHeader = null;
                    }
                });

                // Double click for sorting
                header.addEventListener('dblclick', (e) => {
                    e.preventDefault();
                    const sortKey = header.getAttribute('data-sort');
                    if (sortKey) {
                        sortTable(sortKey, header);
                    }
                });
            });

            function reorderColumns(fromIndex, toIndex) {
                const rows = table.querySelectorAll('tr');
                rows.forEach(row => {
                    const cells = Array.from(row.cells);
                    const cellToMove = cells[fromIndex];
                    if (fromIndex < toIndex) {
                        cells[toIndex].after(cellToMove);
                    } else {
                        cells[toIndex].before(cellToMove);
                    }
                });
            }

            function sortTable(sortKey, header) {
                const tbody = table.querySelector('tbody');
                const rows = Array.from(tbody.querySelectorAll('tr'));
                const index = header.cellIndex;
                const isNumeric = sortKey === 'id' || sortKey === 'numberOfParticipants';
                const isDate = sortKey === 'eventDate';

                // Toggle sort direction
                const currentDirection = header.classList.contains('sorted-asc') ? 'desc' : 'asc';
                headers.forEach(h => {
                    h.classList.remove('sorted-asc', 'sorted-desc');
                });
                header.classList.add(`sorted-${currentDirection}`);

                rows.sort((rowA, rowB) => {
                    let cellA = rowA.cells[index].textContent.trim();
                    let cellB = rowB.cells[index].textContent.trim();

                    if (isNumeric) {
                        cellA = parseFloat(cellA) || 0;
                        cellB = parseFloat(cellB) || 0;
                    } else if (isDate) {
                        cellA = cellA ? new Date(cellA) : new Date(0);
                        cellB = cellB ? new Date(cellB) : new Date(0);
                    }

                    if (currentDirection === 'asc') {
                        return cellA > cellB ? 1 : -1;
                    } else {
                        return cellA < cellB ? 1 : -1;
                    }
                });

                // Re-append rows in sorted order
                tbody.innerHTML = '';
                rows.forEach(row => tbody.appendChild(row));
            }
            // View Analytics button to show dashboard and fetch data
            $('#viewAnalytics').click(function(e) {
                e.preventDefault();
                $('#dashboardSection').removeClass('hidden');
                $.ajax({
                    url: '/api/dashboardStats',
                    method: 'GET',
                    success: function(data) {
                        // Update metric cards
                        $('#totalActivities').text(data.totalActivities);
                        $('#totalParticipants').text(data.totalParticipants);
                        $('#uniqueStates').text(data.uniqueStates);
                        $('#averageParticipants').text(data.averageParticipants);

                        // Render Events by Date chart
                        const dateLabels = Object.keys(data.dateCounts);
                        const dateData = Object.values(data.dateCounts);
                        const dateChartCanvas = document.getElementById('eventsByDateChart');
                        if (dateChartCanvas) {
                            dateChartCanvas.chart = new Chart(dateChartCanvas, {
                                type: 'bar',
                                data: {
                                    labels: dateLabels,
                                    datasets: [{
                                        label: 'Events by Date',
                                        data: dateData,
                                        backgroundColor: '#36A2EB',
                                        borderColor: '#2E8BC0',
                                        borderWidth: 1
                                    }]
                                },
                                options: {
                                    scales: {
                                        y: { beginAtZero: true }
                                    },
                                    plugins: {
                                        legend: { display: false },
                                        title: { display: false }
                                    },
                                    maintainAspectRatio: false
                                }
                            });
                        }

                        // Render Category Distribution chart
                        const categoryLabels = Object.keys(data.categoryCounts);
                        const categoryData = Object.values(data.categoryCounts);
                        const categoryChartCanvas = document.getElementById('categoryChart');
                        if (categoryChartCanvas) {
                            categoryChartCanvas.chart = new Chart(categoryChartCanvas, {
                                type: 'pie',
                                data: {
                                    labels: categoryLabels,
                                    datasets: [{
                                        label: 'Category Distribution',
                                        data: categoryData,
                                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'],
                                        borderColor: ['#D81B60', '#2E8BC0', '#FFB300', '#3BA8A8', '#7B4CCA'],
                                        borderWidth: 1
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    plugins: {
                                        legend: { position: 'bottom', labels: { font: { size: 12 } } },
                                        title: { display: false }
                                    },
                                    maintainAspectRatio: false
                                }
                            });
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error fetching dashboard stats:', error);
                    }
                });
            });

            // Close Dashboard button
            $('#closeDashboard').click(function() {
                $('#dashboardSection').addClass('hidden');
                // Destroy existing charts to prevent memory leaks
                const dateChartCanvas = document.getElementById('eventsByDateChart');
                const categoryChartCanvas = document.getElementById('categoryChart');
                if (dateChartCanvas && dateChartCanvas.chart) {
                    dateChartCanvas.chart.destroy();
                    dateChartCanvas.chart = null;
                }
                if (categoryChartCanvas && categoryChartCanvas.chart) {
                    categoryChartCanvas.chart.destroy();
                    categoryChartCanvas.chart = null;
                }
                // Reset zoom level to default (100%)
                zoomLevel = 1;
                $('#dashboardSection').css({
                    'transform': `scale(${zoomLevel})`,
                    'width': `${100 / zoomLevel}%`
                });
            });
        });
        document.querySelectorAll('.delete-files').forEach(button => {
            button.addEventListener('click', () => {
                const activityId = button.dataset.id;
                if (confirm('Are you sure you want to delete all images for this activity?')) {
                    showSpinner();
                    fetch(`/activities/files/${activityId}`, {
                        method: 'DELETE'
                    }).then(response => {
                        if (response.ok) {
                            const dropdown = button.closest('.dropdown');
                            const disabledButton = dropdown.parentElement.querySelector('.download-btn[disabled]');
                            dropdown.remove();
                            if (disabledButton) {
                                disabledButton.style.display = 'block';
                            }
                            alert('All images deleted successfully!');
                        } else {
                            alert('Failed to delete images.');
                        }
                    }).catch(error => {
                        console.error('Delete images failed:', error);
                        alert('Failed to delete images.');
                    }).finally(hideSpinner);
                }
            });
        });
        function updateSelectedCount() {
            const selected = document.querySelectorAll('.selectRow:checked').length;
            document.getElementById('selectedCount').textContent = selected;
        }

        // NLP for Field Mapping, Show Images, and New Commands
        function parseNLPCommand(command, isVoiceInput = false) {
            const fieldMap = {
                'state': { inputId: 'bulkState', name: 'state' },
                'station name': { inputId: 'bulkStationName', name: 'stationName' },
                'activity type': { inputId: 'bulkActivityType', name: 'activityType' },
                'event category': { inputId: 'bulkEventCategory', name: 'eventCategory' },
                'participant category': { inputId: 'bulkParticipantCategory', name: 'participantCategory' },
                'event description': { inputId: 'bulkEventDescription', name: 'eventDescription' },
                'school': { inputId: 'bulkSchoolOrCollegeOrPanchayatName', name: 'schoolOrCollegeOrPanchayatName' },
                'panchayat': { inputId: 'bulkSchoolOrCollegeOrPanchayatName', name: 'schoolOrCollegeOrPanchayatName' },
                'college': { inputId: 'bulkSchoolOrCollegeOrPanchayatName', name: 'schoolOrCollegeOrPanchayatName' },
                'event location': { inputId: 'bulkEventLocation', name: 'eventLocation' },
                'event date': { inputId: 'bulkEventDate', name: 'eventDate' },
                'date': { inputId: 'bulkEventDate', name: 'eventDate' },
                'participants': { inputId: 'bulkNumberOfParticipants', name: 'numberOfParticipants' },
                'number of participants': { inputId: 'bulkNumberOfParticipants', name: 'numberOfParticipants' },
                'remarks': { inputId: 'bulkRemarks', name: 'remarks' }
            };

            // State abbreviation mapping for voice input
            const stateAbbreviations = {
                'ap': 'Andhra Pradesh'
            };

            const trimmedCommand = command.trim().toLowerCase();
            // Handle new commands
            if (trimmedCommand.match(/^(insert a record|add a record|create a record)$/i)) {
                return { success: true, action: 'insertRecord', message: 'Navigating to add new activity form' };
            }
            if (trimmedCommand.match(/^retrieve record with id\s+(\d+)$/i)) {
                const id = trimmedCommand.match(/\d+/)[0];
                return { success: true, action: 'retrieveRecord', id: id, message: `Retrieving record with ID ${id}` };
            }
            if (trimmedCommand.match(/^retrieve all records$/i)) {
                return { success: true, action: 'retrieveAllRecords', message: 'Retrieving all records' };
            }
            if (trimmedCommand.match(/^edit the records$/i)) {
                return { success: true, action: 'editRecords', message: 'Opening bulk edit for selected records' };
            }
            if (trimmedCommand.match(/^logout yes$/i)) {
                return { success: true, action: 'logoutYes', message: 'Logging out' };
            }
            if (trimmedCommand.match(/^logout no$/i)) {
                return { success: true, action: 'logoutNo', message: 'Cancelled logout' };
            }
            if (trimmedCommand.match(/^(existing images|show images)$/i)) {
                return { success: true, action: 'showImages', message: 'Checking for images in selected activities' };
            }
            if (trimmedCommand.match(/^download images$/i)) {
                return { success: true, action: 'downloadImages', message: 'Downloading images for selected activities' };
            }
            if (trimmedCommand.match(/^(view ai suggestions|suggest date|suggest event date)$/i)) {
                return { success: true, action: 'viewAiSuggestions', message: 'Opening AI suggestions modal' };
            }
            if (trimmedCommand.match(/^nav calc$/i)) {
                return { success: true, action: 'navCalc', message: 'Navigating to Calculate section' };
            }
            // Handle field updates (e.g., "state Karnataka")
            const regex = /^(\w+(\s+\w+)*)\s+(.+)$/i;
            const match = command.match(regex);
            if (!match) {
                return { success: false, message: "Invalid command. Use format: '[column name] [value]' (e.g., 'state Karnataka'), 'insert a record', 'retrieve record with id 123', etc." };
            }
            let field = match[1].toLowerCase();
            let value = match[3].trim();

            // Map state abbreviations to full names for voice input
            if (isVoiceInput && field === 'state' && stateAbbreviations[value.toLowerCase()]) {
                value = stateAbbreviations[value.toLowerCase()];
            }

            const fieldInfo = fieldMap[field];
            if (!fieldInfo) {
                return { success: false, message: `Unknown column: ${field}. Try 'state', 'event date', 'insert a record', etc.` };
            }
            if (!validateField(fieldInfo.name, value)) {
                return { success: false, message: `Invalid value for ${field}: ${value}.` };
            }
            return { success: true, action: 'updateField', inputId: fieldInfo.inputId, name: fieldInfo.name, value, message: `Updating ${field} to ${value}` };
        }

        function handleShowImages() {
            const selectedRows = Array.from(document.querySelectorAll('.selectRow:checked'));
            if (selectedRows.length === 0) {
                alert('Please select at least one activity to view images.');
                return;
            }

            const activitiesWithImages = selectedRows.filter(row => {
                const rowId = row.value;
                const downloadBtn = document.querySelector(`tr[data-row-id='${rowId}'] .download-btn:not([disabled])`);
                return !!downloadBtn;
            }).map(row => row.value);

            if (activitiesWithImages.length > 0) {
                alert(`Navigating to edit form for ${activitiesWithImages.length} activities to show images.`);
                activitiesWithImages.forEach(id => {
                    window.open(`/update/${id}`, '_blank');
                });
            } else {
                alert("Sorry, images don't exist for the selected activities.");
            }
        }

        function handleDownloadImages() {
            const selectedRows = Array.from(document.querySelectorAll('.selectRow:checked'));
            if (selectedRows.length === 0) {
                alert('Please select at least one activity to download images.');
                return;
            }

            const activitiesWithImages = selectedRows.filter(row => {
                const rowId = row.value;
                const downloadBtn = document.querySelector(`tr[data-row-id='${rowId}'] .download-btn:not([disabled])`);
                return !!downloadBtn;
            }).map(row => row.value);

            if (activitiesWithImages.length === 0) {
                alert("Sorry, images don't exist for the selected activities.");
                return;
            }

            activitiesWithImages.forEach(id => {
                const dropdownMenu = document.querySelector(`tr[data-row-id='${id}'] .dropdown-menu`);
                if (dropdownMenu) {
                    const fileLinks = dropdownMenu.querySelectorAll('a.dropdown-item:not(.delete-files)');
                    fileLinks.forEach(link => {
                        const url = link.getAttribute('href');
                        const fileName = link.textContent;
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = fileName;
                        a.click();
                    });
                }
            });
            alert(`Downloading images for ${activitiesWithImages.length} activities.`);
        }

        function autoUpdateField(parsed) {
            const selected = Array.from(document.querySelectorAll('.selectRow:checked')).map(cb => cb.value);
            if (selected.length === 0) {
                alert('Please select at least one activity to update.');
                $('#bulkEditModal').modal('hide');
                return;
            }

            const input = document.getElementById(parsed.inputId);
            input.value = parsed.value;
            input.dispatchEvent(new Event('input'));
            document.getElementById('chatbotFeedback').textContent = parsed.message;

            const data = { ids: selected, [parsed.name]: parsed.name === 'numberOfParticipants' ? parseInt(parsed.value) || 0 : parsed.value };
            showConfirmation(`Update ${selected.length} activities? Changes: ${parsed.name}: ${parsed.value}`, () => {
                showSpinner();
                $.ajax({
                    url: '/bulkUpdate',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                    success: () => {
                        document.getElementById('chatbotFeedback').textContent = `Updated ${parsed.name} to ${parsed.value} for ${selected.length} activities.`;
                        $('#bulkEditModal').modal('hide');
                        window.location.reload();
                    },
                    error: (xhr) => {
                        document.getElementById('chatbotFeedback').textContent = `Failed to update: ${xhr.responseJSON?.errorMessage || 'Unknown error'}`;
                    },
                    complete: hideSpinner
                });
            });
        }
        document.getElementById('viewAiSuggestions').addEventListener('click', () => {
            window.location.href = '/ai-suggestions';
        });
        // Search Bar Command Processing
        document.getElementById('searchBar').addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                const command = document.getElementById('searchBar').value;
                const result = parseNLPCommand(command);
                if (result.success) {
                    switch (result.action) {
                        case 'insertRecord':
                            window.location.href = '/add';
                            break;
                        case 'retrieveRecord':
                            window.location.href = `/update/${result.id}`;
                            break;
                        case 'retrieveAllRecords':
                            window.location.href = '/activity?page=0&size=10&sortBy=id&sortDir=asc';
                            break;
                        case 'editRecords':
                            const selected = document.querySelectorAll('.selectRow:checked').length;
                            if (selected === 0) {
                                alert('Please select at least one activity to edit.');
                            } else {
                                $('#bulkEditModal').modal('show');
                                document.getElementById('chatbotFeedback').textContent = result.message;
                            }
                            break;
                        case 'logoutYes':
                            window.location.href = '/confirmExit';
                            break;
                        case 'logoutNo':
                            document.getElementById('searchBar').value = '';
                            alert(result.message);
                            break;
                        case 'showImages':
                            handleShowImages();
                            break;
                        case 'downloadImages':
                            handleDownloadImages();
                            break;
                        case 'updateField':
                            $('#bulkEditModal').modal('show');
                            autoUpdateField(result);
                            break;
                        case 'viewAiSuggestions':
                            window.location.href = '/ai-suggestions';
                            break; 
                        case 'navCalc':
                            document.getElementById('calculationForm').scrollIntoView({ behavior: 'smooth' });
                            document.getElementById('nlpCommand').value = '';
                            document.getElementById('chatbotFeedback').textContent = result.message;
                            break;     
                    }
                } else {
                    alert(result.message);
                }
                document.getElementById('searchBar').value = '';
            }
        });
        // JavaScript to handle modal open/close
           function openGuideModal() {
            const modal = document.getElementById('guideModal');
            const button = document.getElementById('userGuideButton');
            const buttonRect = button.getBoundingClientRect();
            const modalContent = modal.querySelector('.modal-content');

            // Position the modal to the right of the button
            modalContent.style.top = `${buttonRect.top + window.scrollY}px`;
            modalContent.style.left = `${buttonRect.right + window.scrollX + 10}px`; // 10px offset for spacing

            // Ensure the modal doesn't overflow the right edge of the viewport
            const modalWidth = 500; // Fixed width of the modal
            const viewportWidth = window.innerWidth;
            if (buttonRect.right + modalWidth + 10 > viewportWidth) {
                modalContent.style.left = `${buttonRect.left + window.scrollX - modalWidth - 10}px`; // Move to left if overflow
            }

            modal.style.display = 'block';
        }

        // Function to close the User Guide modal
        function closeGuideModal() {
            document.getElementById('guideModal').style.display = 'none';
        }

        // Add event listener for the User Guide button
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('userGuideButton').addEventListener('click', openGuideModal);
        });        // Keyboard Shortcuts
         let isTabPressed = false;
        document.addEventListener('keydown', (event) => {
        	 if (event.key === 'Tab') {
                 isTabPressed = true;
             }
        	    if (event.key === 'ArrowDown' && !event.ctrlKey && !event.shiftKey && !event.altKey) {
        	        event.preventDefault();
        	        document.getElementById('calculationForm').scrollIntoView({ behavior: 'smooth' });
        	        document.getElementById('chatbotFeedback').textContent = 'Navigated to Calculate section';
        	    }
        	    if (event.key === 'ArrowUp' && !event.ctrlKey && !event.shiftKey && !event.altKey) {
        	        event.preventDefault();
        	        const calculateSection = document.getElementById('calculationForm');
        	        const rect = calculateSection.getBoundingClientRect();
        	        const isVisible = rect.top >= 0 && rect.bottom <= window.innerHeight;
        	        if (isVisible) {
        	            window.scrollTo({ top: 0, behavior: 'smooth' });
        	            document.getElementById('chatbotFeedback').textContent = 'Returned to top of the page';
        	        }
        	    }
        	 if (event.ctrlKey && event.shiftKey && event.key.toLowerCase() === 'f') {
        	        event.preventDefault();
        	        document.getElementById('calculationForm').scrollIntoView({ behavior: 'smooth' });
        	        document.getElementById('chatbotFeedback').textContent = 'Navigated to Calculate section';
        	    }
        	 
             // Tab + 1: Logout yes
             if (isTabPressed && event.key === '1' && !event.ctrlKey && !event.shiftKey && !event.altKey) {
                 event.preventDefault();
                 window.location.href = '/confirmExit';
             }
          // Ctrl+I: Insert a record
    if (event.ctrlKey && !event.shiftKey && event.key.toLowerCase() === 'i') {
        event.preventDefault();
        window.location.href = '/add';
    }
    // Ctrl+Shift+R: Retrieve record with ID
    if (event.ctrlKey && event.shiftKey && event.key.toLowerCase() === 'r') {
        event.preventDefault();
        const command = document.getElementById('searchBar').value.trim().toLowerCase();
        if (command.match(/^retrieve record with id\s+\d+$/i)) {
            const id = command.match(/\d+/)[0];
            window.location.href = `/update/${id}`;
        } else {
            alert('Please enter a record ID in the search bar (e.g., "retrieve record with id 123").');
        }
    }
    // Ctrl+Shift+A: Retrieve all records
    if (event.ctrlKey && event.shiftKey && event.key.toLowerCase() === 'a') {
        event.preventDefault();
        window.location.href = '/?page=0&size=10&sortBy=id&sortDir=asc';
    }
    // Ctrl+Shift+E: Edit the records
    if (event.ctrlKey && event.shiftKey && event.key.toLowerCase() === 'e') {
        event.preventDefault();
        const selected = document.querySelectorAll('.selectRow:checked').length;
        if (selected > 0) {
            $('#bulkEditModal').modal('show');
            document.getElementById('chatbotFeedback').textContent = 'Opening bulk edit for selected records';
        } else {
            alert('Please select at least one activity to edit.');
        }
    }
    // Ctrl+Shift+L: Logout yes
    if (event.ctrlKey && event.shiftKey && event.key.toLowerCase() === 'l') {
        event.preventDefault();
        window.location.href = '/confirmExit';
    }
    // Esc: Logout no
    if (event.key === 'Escape') {
        event.preventDefault();
        document.getElementById('searchBar').value = '';
        alert('Cancelled logout');
    }
    // Ctrl+1: Existing images
    if (event.ctrlKey && !event.shiftKey && event.key === '1') {
        event.preventDefault();
        handleShowImages();
    }
    // Ctrl+Shift+D: Download images
    if (event.ctrlKey && event.shiftKey && event.key.toLowerCase() === 'd') {
        event.preventDefault();
        handleDownloadImages();
    }
    if (event.ctrlKey && event.key.toLowerCase() === 'h') {
        event.preventDefault();
        alert('Shortcuts:\n' +
              'Ctrl+I: Insert a record\n' +
              'Ctrl+Shift+R: Retrieve record with ID\n' +
              'Ctrl+Shift+A: Retrieve all records\n' +
              'Ctrl+Shift+E: Edit selected records\n' +
              'Ctrl+Shift+L: Logout (yes)\n' +
              'Esc: Logout (no)\n' +
              'Ctrl+1: View existing images\n' +
              'Ctrl+Shift+D: Download images\n' +
              'Ctrl+Shift+Q: View AI suggestions\n'+
              'Ctrl+Shift+F:Nav Calc(Calculator)');
        
    }
 // Ctrl+Shift+Q: View AI Suggestions
    if (event.ctrlKey && event.shiftKey && event.key.toLowerCase() === 'Q') {
        event.preventDefault();
        $('#aiSuggestionsModal').modal('show');
        fetchAiSuggestions();
        document.getElementById('chatbotFeedback').textContent = 'Opening AI suggestions modal';
    }
        });

        // Voice-to-Text for Bulk Edit
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'en-IN'; // Optimized for Indian English
            recognition.interimResults = true;
            recognition.continuous = true;
            recognition.maxAlternatives = 1;

            const voiceBtn = document.getElementById('voiceInputBtn');
            let recognitionTimeout;

            voiceBtn.addEventListener('click', () => {
                if (voiceBtn.classList.contains('recording')) {
                    recognition.stop();
                    clearTimeout(recognitionTimeout);
                } else {
                    recognition.start();
                    voiceBtn.classList.add('recording');
                    voiceBtn.textContent = '⏹';
                    document.getElementById('chatbotFeedback').textContent = 'Listening for up to 30 seconds...';

                    // Set a timeout to stop recognition after 15 to 30 seconds
                    const minDuration = 15000;
                    const maxDuration = 30000;
                    const duration = minDuration + Math.random() * (maxDuration - minDuration);
                    recognitionTimeout = setTimeout(() => {
                        recognition.stop();
                    }, duration);
                }
            });

            recognition.onresult = (event) => {
                const transcript = Array.from(event.results)
                    .map(result => result[0].transcript)
                    .join('');
                document.getElementById('nlpCommand').value = transcript;
                document.getElementById('nlpCommand').dispatchEvent(new Event('input'));
            };

            recognition.onend = () => {
                voiceBtn.classList.remove('recording');
                voiceBtn.textContent = '🎤';
                clearTimeout(recognitionTimeout);
                if (!document.getElementById('nlpCommand').value) {
                    document.getElementById('chatbotFeedback').textContent = 'No speech detected. Try again.';
                } else {
                    document.getElementById('chatbotFeedback').textContent = 'Processing your voice input...';
                    const command = document.getElementById('nlpCommand').value;
                    const result = parseNLPCommand(command, true);
                    if (result.success) {
                        if (result.action === 'showImages') {
                            handleShowImages();
                        } else {
                            autoUpdateField(result);
                        }
                    } else {
                        document.getElementById('chatbotFeedback').textContent = result.message;
                    }
                }
            };

            recognition.onerror = (event) => {
                document.getElementById('chatbotFeedback').textContent = `Speech recognition error: ${event.error}`;
                voiceBtn.classList.remove('recording');
                voiceBtn.textContent = '🎤';
                clearTimeout(recognitionTimeout);
            };
        } else {
            document.getElementById('voiceInputBtn').disabled = true;
            document.getElementById('voiceInputBtn').title = 'Voice input not supported in this browser';
        }

        // Auto-update on Enter key for NLP command
        document.getElementById('nlpCommand').addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                const command = document.getElementById('nlpCommand').value;
                const result = parseNLPCommand(command);
                if (result.success) {
                    if (result.action === 'showImages') {
                        handleShowImages();
                    } else {
                        autoUpdateField(result);
                    }
                } else {
                    document.getElementById('chatbotFeedback').textContent = result.message;
                }
            }
        });

        document.getElementById('nlpCommand').addEventListener('input', () => {
            const command = document.getElementById('nlpCommand').value;
            const result = parseNLPCommand(command);
            document.getElementById('chatbotFeedback').textContent = result.message;
        });

        // Smart Actions
        document.getElementById('smartActions').addEventListener('change', (e) => {
            const action = e.target.value;
            const feedback = document.getElementById('chatbotFeedback');
            if (action === 'setToday') {
                const today = new Date().toISOString().split('T')[0];
                if (today >= '2024-10-28' && today <= '2024-11-03') {
                    document.getElementById('bulkEventDate').value = today;
                    autoUpdateField({ success: true, inputId: 'bulkEventDate', name: 'eventDate', value: today, message: `Updating event date to ${today}` });
                } else {
                    feedback.textContent = 'Error: Today\'s date is outside allowed range (2024-10-28 to 2024-11-03)';
                }
            } else if (action === 'incrementParticipants') {
                document.getElementById('bulkNumberOfParticipants').value = 10;
                autoUpdateField({ success: true, inputId: 'bulkNumberOfParticipants', name: 'numberOfParticipants', value: '10', message: 'Updating participants to 10' });
            } else if (action === 'clearRemarks') {
                document.getElementById('bulkRemarks').value = '';
                autoUpdateField({ success: true, inputId: 'bulkRemarks', name: 'remarks', value: '', message: 'Clearing remarks' });
            }
            e.target.value = '';
        });

        // Save Individual Rows with Confirmation
        document.querySelectorAll('.save-row').forEach(button => {
            button.addEventListener('click', () => {
                const row = button.closest('tr');
                const id = button.dataset.id;
                const cells = row.querySelectorAll('.editable');
                let isValid = true;
                const data = { id: id };

                cells.forEach(cell => {
                    const field = cell.dataset.field;
                    const value = field === 'eventDescription' || field === 'remarks' ? cell.innerHTML : cell.textContent.trim();
                    if (!validateField(field, value)) {
                        isValid = false;
                        cell.classList.add('is-invalid');
                        cell.querySelector('.invalid-feedback').style.display = 'block';
                    } else {
                        cell.classList.remove('is-invalid');
                        cell.querySelector('.invalid-feedback').style.display = 'none';
                        data[field] = value;
                    }
                });

                if (!isValid) {
                    alert('Please correct the invalid fields before saving.');
                    return;
                }

                if (data.numberOfParticipants) {
                    data.numberOfParticipants = parseInt(data.numberOfParticipants) || 0;
                }

                const changes = Object.keys(data)
                    .filter(key => key !== 'id')
                    .map(key => `${key}: ${data[key]}`)
                    .join(', ');
                showConfirmation(`Save changes for activity ${id}? Changes: ${changes}`, () => {
                    showSpinner();
                    $.ajax({
                        url: '/save',
                        method: 'POST',
                        contentType: 'application/x-www-form-urlencoded',
                        data: $.param(data),
                        success: () => {
                            alert('Activity updated successfully!');
                        },
                        error: (xhr) => {
                            alert('Failed to update activity: ' + (xhr.responseJSON?.errorMessage || 'Unknown error'));
                        },
                        complete: hideSpinner
                    });
                });
            });
        });

        // Bulk Edit with Confirmation
        document.getElementById('bulkEdit').addEventListener('click', () => {
            const selected = Array.from(document.querySelectorAll('.selectRow:checked')).map(cb => cb.value);
            if (selected.length === 0) {
                alert('Please select at least one activity to edit.');
                return;
            }
            document.getElementById('bulkEditForm').reset();
            document.querySelectorAll('#bulkEditForm .is-invalid').forEach(el => el.classList.remove('is-invalid'));
            document.querySelectorAll('#bulkEditForm .invalid-feedback').forEach(el => el.style.display = 'none');
            document.getElementById('nlpCommand').value = '';
            document.getElementById('chatbotFeedback').textContent = 'Enter a command (e.g., "state Andhra Pradesh" or "show images") or use voice input.';
            updateSelectedCount();
        });

        document.getElementById('saveBulkEdit').addEventListener('click', () => {
            const selected = Array.from(document.querySelectorAll('.selectRow:checked')).map(cb => cb.value);
            if (selected.length === 0) {
                alert('Please select at least one activity to edit.');
                $('#bulkEditModal').modal('hide');
                return;
            }

            const form = document.getElementById('bulkEditForm');
            const formData = new FormData(form);
            const data = { ids: selected };
            let isValid = true;

            formData.forEach((value, key) => {
                if (value.trim() !== '') {
                    if (!validateField(key, value)) {
                        isValid = false;
                        const input = form.querySelector(`[name="${key}"]`);
                        input.classList.add('is-invalid');
                        input.nextElementSibling.style.display = 'block';
                    } else {
                        const input = form.querySelector(`[name="${key}"]`);
                        input.classList.remove('is-invalid');
                        input.nextElementSibling.style.display = 'none';
                        if (key === 'numberOfParticipants') {
                            data[key] = parseInt(value) || 0;
                        } else {
                            data[key] = value;
                        }
                    }
                }
            });

            if (!isValid) {
                alert('Please correct the invalid fields before saving.');
                return;
            }

            const changes = Object.keys(data)
                .filter(key => key !== 'ids')
                .map(key => `${key}: ${data[key]}`)
                .join(', ');
            showConfirmation(`Update ${selected.length} activities? Changes: ${changes}`, () => {
                showSpinner();
                $.ajax({
                    url: '/bulkUpdate',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                    success: () => {
                        alert('Activities updated successfully!');
                        $('#bulkEditModal').modal('hide');
                        window.location.reload();
                    },
                    error: (xhr) => {
                        alert('Failed to update activities: ' + (xhr.responseJSON?.errorMessage || 'Unknown error'));
                    },
                    complete: hideSpinner
                });
            });
        });

        // Confirmation Modal
        function showConfirmation(message, onConfirm) {
            const modal = document.getElementById('confirmationModal');
            document.getElementById('confirmationMessage').textContent = message;
            modal.style.display = 'flex';

            const confirmBtn = document.getElementById('confirmSave');
            const cancelBtn = document.getElementById('cancelSave');
            const confirmHandler = () => {
                onConfirm();
                modal.style.display = 'none';
                confirmBtn.removeEventListener('click', confirmHandler);
            };
            confirmBtn.addEventListener('click', confirmHandler);
            cancelBtn.addEventListener('click', () => {
                modal.style.display = 'none';
                confirmBtn.removeEventListener('click', confirmHandler);
            });
        }

        // Bulk Delete
        document.getElementById('bulkDelete').addEventListener('click', () => {
            const selected = Array.from(document.querySelectorAll('.selectRow:checked')).map(cb => cb.value);
            if (selected.length === 0) {
                alert('Please select at least one activity to delete.');
                return;
            }
            if (confirm(`Are you sure you want to delete ${selected.length} activities?`)) {
                showSpinner();
                $.ajax({
                    url: '/delete/bulk',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(selected),
                    success: () => {
                        window.location.reload();
                    },
                    error: () => {
                        alert('Failed to delete activities.');
                    },
                    complete: hideSpinner
                });
            }
        });
        // Select All Checkbox
        document.getElementById('selectAll').addEventListener('change', (e) => {
            document.querySelectorAll('.selectRow').forEach(cb => {
                cb.checked = e.target.checked;
                cb.dispatchEvent(new Event('change'));
            });
        });

        // Export to CSV
        document.getElementById('exportCsv').addEventListener('click', () => {
            const rows = [];
            const headers = Array.from(document.querySelectorAll('th[data-col]')).map(th => th.dataset.col);
            rows.push(headers.join(','));
            document.querySelectorAll('#activityTable tr').forEach(row => {
                const cells = Array.from(row.querySelectorAll('td.editable')).map(cell => `"${cell.textContent.replace(/"/g, '""')}"`);
                if (cells.length > 0) {
                    rows.push(cells.join(','));
                }
            });
            const csv = rows.join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'activities.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        });

    
       
        // Delete All Images
        document.querySelectorAll('.delete-files').forEach(button => {
            button.addEventListener('click', () => {
                const activityId = button.dataset.id;
                if (confirm('Are you sure you want to delete all images for this activity?')) {
                    showSpinner();
                    fetch(`/activities/files/${activityId}`, {
                        method: 'DELETE'
                    }).then(response => {
                        if (response.ok) {
                            const dropdown = button.closest('.dropdown');
                            const disabledButton = dropdown.parentElement.querySelector('.download-btn[disabled]');
                            dropdown.remove();
                            if (disabledButton) {
                                disabledButton.style.display = 'block';
                            }
                            alert('All images deleted successfully!');
                        } else {
                            alert('Failed to delete images.');
                        }
                    }).catch(error => {
                        console.error('Delete images failed:', error);
                        alert('Failed to delete images.');
                    }).finally(hideSpinner);
                }
            });
        });

        // Session Timeout Warning
        let timeoutId;
        function resetSessionTimer() {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => {
                document.querySelector('.session-warning').style.display = 'block';
                setTimeout(() => {
                    window.location.href = '/confirmExit';
                }, 60000); // Redirect after 1 minute
            }, 1800000); // Show warning after 30 minutes of inactivity
        }

        document.getElementById('extendSession').addEventListener('click', () => {
            document.querySelector('.session-warning').style.display = 'none';
            resetSessionTimer();
            // Optionally, send a request to the server to extend the session
            fetch('/extendSession', { method: 'POST' })
                .then(response => {
                    if (!response.ok) {
                        console.error('Failed to extend session');
                    }
                });
        });

        // Reset session timer on user activity
        ['click', 'keydown', 'mousemove'].forEach(event => {
            document.addEventListener(event, resetSessionTimer);
        });

        // Initialize session timer
        resetSessionTimer();

        // Initialize Flatpickr for date inputs
        flatpickr('#bulkEventDate', {
            dateFormat: 'Y-m-d',
            maxDate: '2024-11-03',
            minDate: '2024-10-28'
        });

        // Initialize Select2 for dropdowns
        $('#smartActions').select2({
            placeholder: 'Select a smart action',
            allowClear: true
        });

        // Page Size Selection
        document.getElementById('pageSizeSelect').addEventListener('change', (e) => {
            const size = e.target.value;
            const sortBy = document.querySelector('th[aria-sort="ascending"]')?.dataset.sort ||
                          document.querySelector('th[aria-sort="descending"]')?.dataset.sort || 'id';
            const sortDir = document.querySelector('th[aria-sort="ascending"]') ? 'asc' :
                           document.querySelector('th[aria-sort="descending"]') ? 'desc' : 'asc';
            window.location.href = `activity/?page=0&size=${size}&sortBy=${sortBy}&sortDir=${sortDir}`;
        });
        // Server-Sent Events for Real-Time Updates
        const eventSource = new EventSource('/activities/updates');
        eventSource.onmessage = function(event) {
            const data = JSON.parse(event.data);
            if (data.action === 'HEARTBEAT') return;

            if (data.action === 'ADD' || data.action === 'UPDATE' || data.action === 'BULK_UPDATE') {
                if (data.action === 'ADD') {
                    window.location.reload();
                } else {
                    (data.activities || [data.activity]).forEach(activity => {
                        const row = document.querySelector(`tr[data-row-id='${activity.id}']`);
                        if (row) {
                            row.querySelector('[data-field="state"]').textContent = activity.state || row.querySelector('[data-field="state"]').textContent;
                            row.querySelector('[data-field="stationName"]').textContent = activity.stationName || row.querySelector('[data-field="stationName"]').textContent;
                            row.querySelector('[data-field="activityType"]').textContent = activity.activityType || row.querySelector('[data-field="activityType"]').textContent;
                            row.querySelector('[data-field="eventCategory"]').textContent = activity.eventCategory || row.querySelector('[data-field="eventCategory"]').textContent;
                            row.querySelector('[data-field="participantCategory"]').textContent = activity.participantCategory || row.querySelector('[data-field="participantCategory"]').textContent;
                            row.querySelector('[data-field="eventDescription"]').innerHTML = activity.eventDescription || row.querySelector('[data-field="eventDescription"]').innerHTML;
                            row.querySelector('[data-field="schoolOrCollegeOrPanchayatName"]').textContent = activity.schoolOrCollegeOrPanchayatName || row.querySelector('[data-field="schoolOrCollegeOrPanchayatName"]').textContent;
                            row.querySelector('[data-field="eventLocation"]').textContent = activity.eventLocation || row.querySelector('[data-field="eventLocation"]').textContent;
                            row.querySelector('[data-field="eventDate"]').textContent = activity.eventDate || row.querySelector('[data-field="eventDate"]').textContent;
                            row.querySelector('[data-field="numberOfParticipants"]').textContent = activity.numberOfParticipants !== undefined ? activity.numberOfParticipants : row.querySelector('[data-field="numberOfParticipants"]').textContent;
                            row.querySelector('[data-field="remarks"]').innerHTML = activity.remarks || row.querySelector('[data-field="remarks"]').innerHTML;
                        }
                    });

                    if (data.action !== 'ADD' && data.files) {
                        (data.activities || [data.activity]).forEach(activity => {
                            const row = document.querySelector(`tr[data-row-id='${activity.id}']`);
                            if (row) {
                                const downloadCell = row.querySelector('.actions');
                                const existingDropdown = downloadCell.querySelector('.dropdown');
                                const disabledButton = downloadCell.querySelector('.download-btn[disabled]');
                                const files = data.files.filter(f => f.activity.id === activity.id);
                                if (files.length > 0) {
                                    if (existingDropdown) {
                                        existingDropdown.querySelector('.dropdown-menu').innerHTML = files.map(file => 
                                            `<a class="dropdown-item" href="/api/download/${file.id}">${file.fileName}</a>`
                                        ).join('') + '<div class="dropdown-divider"></div><a class="dropdown-item text-danger delete-files" data-id="' + activity.id + '">Delete All Images</a>';
                                    } else {
                                        const dropdown = document.createElement('div');
                                        dropdown.className = 'dropdown';
                                        dropdown.innerHTML = `
                                            <button class="btn btn-sm btn-primary download-btn" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" data-id="${activity.id}">
                                                Download
                                            </button>
                                            <div class="dropdown-menu">
                                                ${files.map(file => `<a class="dropdown-item" href="/api/download/${file.id}">${file.fileName}</a>`).join('')}
                                                <div class="dropdown-divider"></div>
                                                <a class="dropdown-item text-danger delete-files" data-id="${activity.id}">Delete All Images</a>
                                            </div>`;
                                        if (disabledButton) disabledButton.remove();
                                        downloadCell.appendChild(dropdown);
                                    }
                                } else {
                                    if (existingDropdown) existingDropdown.remove();
                                    if (!disabledButton) {
                                        const disabledBtn = document.createElement('button');
                                        disabledBtn.className = 'btn btn-sm btn-primary download-btn';
                                        disabledBtn.disabled = true;
                                        disabledBtn.textContent = 'Download';
                                        disabledBtn.dataset.id = activity.id;
                                        disabledBtn.setAttribute('aria-label', `No images available for activity ${activity.id}`);
                                        downloadCell.appendChild(disabledBtn);
                                    }
                                }
                            }
                        });
                    }
                }
            } else if (data.action === 'DELETE') {
                data.deletedIds.forEach(id => {
                    const row = document.querySelector(`tr[data-row-id='${id}']`);
                    if (row) row.remove();
                });
            }
            updateSelectedCount();
        };
        eventSource.onerror = function() {
            console.error('SSE connection error');
            eventSource.close();
            setTimeout(() => {
                window.location.reload();
            }, 5000);
        };
    </script>
</body>
</html>